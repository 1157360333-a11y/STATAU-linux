# STATAU 邮箱验证功能使用说明

## 📧 功能概述

STATAU 现已支持邮箱验证码注册功能。用户在注册时需要通过邮箱接收验证码，验证邮箱真实性后才能完成注册。

---

## 🚀 快速开始

### 0. 数据库迁移（重要！）

**如果您是从旧版本升级，必须先运行数据库迁移脚本：**

```bash
python migrate_db.py
```

此脚本会为 users 表添加 `email_verified` 字段。

**输出示例：**
```
======================================================================
STATAU 数据库迁移工具
======================================================================

[INFO] 正在添加 email_verified 字段...
[OK] 成功添加 email_verified 字段
[SUCCESS] 数据库迁移成功！
          数据库路径: instance/statau.db
          新增字段: email_verified (BOOLEAN, 默认值: False)

[DONE] 迁移完成！现在可以运行 python app.py 启动应用
======================================================================
```

### 1. 配置邮件服务器

在使用邮箱验证功能前，需要先配置 SMTP 邮件服务器。

#### 方式一：修改配置文件

编辑 [`config.py`](config.py:57) 文件，修改以下配置：

```python
# 邮件服务器配置
MAIL_SERVER = 'smtp.qq.com'  # SMTP 服务器地址
MAIL_PORT = 587               # SMTP 端口
MAIL_USE_TLS = True           # 是否使用 TLS 加密
MAIL_USERNAME = 'your_email@qq.com'      # 发件邮箱
MAIL_PASSWORD = 'your_auth_code'         # 邮箱授权码
MAIL_SENDER_NAME = 'STATAU'   # 发件人名称
```

#### 方式二：使用环境变量（推荐）

设置以下环境变量：

```bash
export MAIL_SERVER=smtp.qq.com
export MAIL_PORT=587
export MAIL_USERNAME=your_email@qq.com
export MAIL_PASSWORD=your_auth_code
```

---

## 📮 常用邮箱 SMTP 配置

### QQ 邮箱
- **服务器**: `smtp.qq.com`
- **端口**: `587` (TLS) 或 `465` (SSL)
- **授权码获取**: 
  1. 登录 QQ 邮箱网页版
  2. 设置 → 账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
  3. 开启 SMTP 服务
  4. 生成授权码（不是 QQ 密码）

### 163 邮箱
- **服务器**: `smtp.163.com`
- **端口**: `25` 或 `465`
- **授权码获取**: 设置 → POP3/SMTP/IMAP → 开启服务并获取授权码

### Gmail
- **服务器**: `smtp.gmail.com`
- **端口**: `587`
- **授权码获取**: 需要开启"两步验证"并生成应用专用密码

### 企业邮箱
请咨询您的邮箱服务提供商获取 SMTP 配置信息。

---

## 🔧 功能实现说明

### 后端实现

#### 1. 邮件服务模块 ([`services/email_service.py`](services/email_service.py:1))

提供以下功能：
- [`generate_code()`](services/email_service.py:48): 生成 6 位数字验证码
- [`send_verification_code()`](services/email_service.py:54): 发送验证码邮件
- [`verify_code()`](services/email_service.py:145): 验证验证码
- [`clear_code()`](services/email_service.py:167): 清除验证码

验证码有效期：**5 分钟**

#### 2. 新增 API 接口 ([`blueprints/auth.py`](blueprints/auth.py:1))

**发送邮箱验证码**
- **URL**: `POST /api/send_email_code`
- **请求体**:
  ```json
  {
    "email": "user@example.com"
  }
  ```
- **响应**:
  ```json
  {
    "status": "success",
    "message": "验证码已发送至 user@example.com，请查收邮件（有效期5分钟）"
  }
  ```

**注册接口更新**
- **URL**: `POST /api/register`
- **请求体**:
  ```json
  {
    "username": "用户名",
    "email": "邮箱",
    "password": "密码",
    "captcha": "图形验证码",
    "email_code": "邮箱验证码"
  }
  ```

#### 3. 数据库模型更新 ([`core/auth.py`](core/auth.py:68))

User 模型新增字段：
- `email_verified`: 布尔值，标识邮箱是否已验证

### 前端实现 ([`templates/base.html`](templates/base.html:1))

#### 1. 注册表单新增元素

- 邮箱验证码输入框
- "发送验证码"按钮（带倒计时功能）

#### 2. JavaScript 函数

- [`sendEmailCode()`](templates/base.html:541): 发送邮箱验证码
  - 验证邮箱格式
  - 发送请求到后端
  - 60 秒倒计时防止重复发送

- [`handleRegister()`](templates/base.html:618): 注册逻辑更新
  - 增加邮箱验证码验证
  - 提交时包含邮箱验证码

---

## 📝 使用流程

### 用户注册流程

1. **填写基本信息**
   - 输入用户名
   - 输入邮箱地址

2. **获取邮箱验证码**
   - 点击"发送验证码"按钮
   - 系统发送验证码到邮箱
   - 按钮进入 60 秒倒计时

3. **查收邮件**
   - 打开邮箱
   - 查看来自 STATAU 的验证码邮件
   - 复制 6 位数字验证码

4. **完成注册**
   - 输入邮箱验证码
   - 设置密码并确认
   - 输入图形验证码
   - 点击"注册账户"

5. **注册成功**
   - 系统验证所有信息
   - 创建账户并标记邮箱已验证
   - 自动跳转到登录页面

---

## ⚠️ 注意事项

### 1. 邮箱配置

- **必须配置正确的 SMTP 信息**，否则无法发送验证码
- **使用授权码而非登录密码**（QQ、163 等邮箱）
- **建议使用环境变量**存储敏感信息，避免泄露

### 2. 验证码安全

- 验证码有效期为 **5 分钟**
- 验证码使用后自动失效
- 每个邮箱同时只能有一个有效验证码

### 3. 防刷机制

- 发送验证码后 **60 秒内不能重复发送**
- 前端按钮倒计时提示

### 4. 错误处理

常见错误及解决方案：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 邮箱认证失败 | SMTP 用户名或密码错误 | 检查配置，确认使用授权码 |
| 邮件发送失败 | SMTP 服务器连接失败 | 检查服务器地址和端口 |
| 该邮箱已被注册 | 邮箱已存在 | 使用其他邮箱或找回密码 |
| 验证码错误或已过期 | 验证码输入错误或超时 | 重新获取验证码 |

---

## 🔍 测试建议

### 开发环境测试

1. **配置测试邮箱**
   - 使用个人邮箱进行测试
   - 确保 SMTP 服务已开启

2. **测试流程**
   ```bash
   # 1. 启动应用
   python app.py
   
   # 2. 访问注册页面
   http://localhost:5000
   
   # 3. 测试注册流程
   - 填写信息
   - 发送验证码
   - 查收邮件
   - 完成注册
   ```

3. **验证功能**
   - 检查邮件是否正常接收
   - 验证码是否正确
   - 注册是否成功
   - 数据库中 `email_verified` 字段是否为 `True`

### 生产环境部署

1. **使用环境变量配置**
   ```bash
   export MAIL_SERVER=smtp.your-domain.com
   export MAIL_USERNAME=noreply@your-domain.com
   export MAIL_PASSWORD=your_secure_password
   ```

2. **建议使用企业邮箱**
   - 更稳定的发送能力
   - 更高的发送限额
   - 更好的送达率

3. **监控邮件发送**
   - 记录发送日志
   - 监控发送成功率
   - 处理发送失败情况

---

## 📚 相关文件

- [`services/email_service.py`](services/email_service.py:1) - 邮件服务模块
- [`blueprints/auth.py`](blueprints/auth.py:1) - 认证路由（包含邮箱验证码 API）
- [`core/auth.py`](core/auth.py:1) - 用户模型（包含 email_verified 字段）
- [`config.py`](config.py:1) - 配置文件（邮件服务器配置）
- [`templates/base.html`](templates/base.html:1) - 前端模板（注册表单）

---

## 🆘 常见问题

### Q1: 收不到验证码邮件？

**可能原因**：
1. SMTP 配置错误
2. 邮箱授权码不正确
3. 邮件被拦截到垃圾箱
4. 网络连接问题

**解决方案**：
1. 检查 [`config.py`](config.py:57) 中的配置
2. 确认使用的是授权码而非登录密码
3. 查看邮箱的垃圾邮件文件夹
4. 检查服务器网络连接

### Q2: 验证码总是提示错误？

**可能原因**：
1. 验证码已过期（超过 5 分钟）
2. 输入的验证码不正确
3. 验证码已被使用

**解决方案**：
1. 重新获取验证码
2. 仔细核对验证码（6 位数字）
3. 确保在有效期内使用

### Q3: 如何更换邮件服务器？

修改 [`config.py`](config.py:57) 中的配置：
```python
MAIL_SERVER = 'smtp.your-server.com'
MAIL_PORT = 587
MAIL_USERNAME = 'your_email@domain.com'
MAIL_PASSWORD = 'your_password'
```

---

## 📞 技术支持

如有问题，请查看：
- 项目 README: [`README.md`](README.md:1)
- 架构文档: [`ARCHITECTURE.md`](ARCHITECTURE.md:1)

---

**最后更新**: 2026-01-20
