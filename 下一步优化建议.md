# STATAU 网站下一步优化建议

## 📋 优化方向概述

本文档为STATAU项目提供模块化的优化建议,每个建议都是独立的功能模块,可以单独实现。

---

## 🎯 优先级分类

### 🔴 高优先级(用户体验提升)

#### 1. 密码重置功能
**需求描述**: 用户忘记密码时,可以通过邮箱重置密码

**实现要点**:
- 在登录页面添加"忘记密码"链接
- 创建密码重置页面模板
- 在 [`blueprints/auth.py`](blueprints/auth.py:1) 添加以下API:
  - `POST /api/request_reset` - 发送重置密码邮件
  - `POST /api/reset_password` - 验证token并重置密码
- 使用 [`services/email_service.py`](services/email_service.py:1) 发送重置链接
- 生成带时效性的重置token(可使用itsdangerous库)

**涉及文件**:
- `blueprints/auth.py` - 添加重置密码API
- `templates/base.html` - 添加忘记密码链接
- `templates/reset_password.html` - 新建重置密码页面
- `services/email_service.py` - 添加发送重置邮件方法

---

#### 2. 用户个人中心
**需求描述**: 用户可以查看和修改个人信息

**实现要点**:
- 创建个人中心页面 `templates/profile.html`
- 在 [`blueprints/pages.py`](blueprints/pages.py:1) 添加路由 `/profile`
- 在 [`blueprints/auth.py`](blueprints/auth.py:1) 添加API:
  - `GET /api/profile` - 获取用户信息
  - `POST /api/profile/update` - 更新用户信息
  - `POST /api/profile/change_password` - 修改密码
- 显示用户的注册时间、邮箱验证状态等信息
- 支持修改用户名、邮箱(需重新验证)

**涉及文件**:
- `blueprints/pages.py` - 添加个人中心路由
- `blueprints/auth.py` - 添加个人信息API
- `templates/profile.html` - 新建个人中心页面
- `templates/base.html` - 更新导航栏链接

---

#### 3. 数据分析历史记录
**需求描述**: 保存用户的分析历史,方便查看和重新运行

**实现要点**:
- 在 [`core/auth.py`](core/auth.py:1) 创建 `Analysis` 模型:
  ```python
  class Analysis(db.Model):
      id = db.Column(db.Integer, primary_key=True)
      user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
      filename = db.Column(db.String(200))
      method = db.Column(db.String(50))
      parameters = db.Column(db.Text)  # JSON格式存储
      result_html = db.Column(db.Text)
      created_at = db.Column(db.DateTime)
  ```
- 在 [`blueprints/analysis.py`](blueprints/analysis.py:1) 的分析接口中保存记录
- 创建历史记录页面 `templates/history.html`
- 添加API:
  - `GET /api/history` - 获取历史记录列表
  - `GET /api/history/<id>` - 查看单个历史记录
  - `DELETE /api/history/<id>` - 删除历史记录

**涉及文件**:
- `core/auth.py` - 添加Analysis模型
- `blueprints/analysis.py` - 保存分析记录
- `blueprints/pages.py` - 添加历史记录页面路由
- `templates/history.html` - 新建历史记录页面

---

### 🟡 中优先级(功能增强)

#### 4. 数据可视化
**需求描述**: 为分析结果添加图表展示

**实现要点**:
- 使用 `matplotlib` 或 `plotly` 生成图表
- 在 [`core/models.py`](core/models.py:1) 的 `StataModel` 类添加绘图方法
- 支持的图表类型:
  - 散点图(变量关系)
  - 直方图(变量分布)
  - 箱线图(异常值检测)
  - 残差图(回归诊断)
- 将图表转为base64编码嵌入HTML或保存为文件
- 在分析结果页面展示图表

**涉及文件**:
- `core/models.py` - 添加绘图方法
- `templates/analysis.html` - 添加图表展示区域
- `requirements.txt` - 添加matplotlib或plotly依赖

---

#### 5. 数据预处理功能
**需求描述**: 提供数据清洗和转换功能

**实现要点**:
- 在 [`services/file_service.py`](services/file_service.py:1) 添加数据处理方法:
  - 缺失值处理(删除、填充)
  - 异常值检测和处理
  - 变量标准化/归一化
  - 生成虚拟变量
  - 变量对数转换
- 在分析页面添加"数据预处理"选项卡
- 提供预处理后的数据预览
- 支持下载处理后的数据

**涉及文件**:
- `services/file_service.py` - 添加数据处理方法
- `blueprints/analysis.py` - 添加数据处理API
- `templates/analysis.html` - 添加预处理界面

---

#### 6. 结果导出功能
**需求描述**: 支持将分析结果导出为多种格式

**实现要点**:
- 在 [`core/table_generator.py`](core/table_generator.py:1) 添加导出方法
- 支持的格式:
  - Word文档(.docx) - 使用python-docx库
  - Excel表格(.xlsx) - 使用openpyxl库
  - LaTeX代码(.tex) - 直接生成LaTeX表格代码
  - PDF文件(.pdf) - 使用reportlab库
- 在分析结果页面添加"导出"按钮
- 添加API: `POST /api/export` - 导出分析结果

**涉及文件**:
- `core/table_generator.py` - 添加导出方法
- `blueprints/analysis.py` - 添加导出API
- `templates/analysis.html` - 添加导出按钮
- `requirements.txt` - 添加相关依赖

---

### 🟢 低优先级(体验优化)

#### 7. 操作日志系统
**需求描述**: 记录管理员的所有操作,便于审计

**实现要点**:
- 创建 `OperationLog` 模型:
  ```python
  class OperationLog(db.Model):
      id = db.Column(db.Integer, primary_key=True)
      admin_id = db.Column(db.Integer, db.ForeignKey('users.id'))
      operation = db.Column(db.String(100))  # 操作类型
      target = db.Column(db.String(200))     # 操作对象
      details = db.Column(db.Text)           # 详细信息
      ip_address = db.Column(db.String(50))
      created_at = db.Column(db.DateTime)
  ```
- 在 [`blueprints/admin.py`](blueprints/admin.py:1) 的所有操作中记录日志
- 在管理后台添加"操作日志"页面
- 支持按时间、操作类型、管理员筛选

**涉及文件**:
- `core/auth.py` - 添加OperationLog模型
- `blueprints/admin.py` - 记录操作日志
- `templates/admin.html` - 添加日志查看功能

---

#### 8. 数据库备份功能
**需求描述**: 管理员可以备份和恢复数据库

**实现要点**:
- 在 [`blueprints/admin.py`](blueprints/admin.py:1) 添加API:
  - `POST /admin/backup` - 创建数据库备份
  - `GET /admin/backups` - 获取备份列表
  - `POST /admin/restore` - 恢复数据库
- 使用SQLite的备份命令或直接复制数据库文件
- 备份文件存储在 `backups/` 目录
- 支持定时自动备份(使用APScheduler库)

**涉及文件**:
- `blueprints/admin.py` - 添加备份API
- `templates/admin.html` - 添加备份管理界面
- `requirements.txt` - 添加APScheduler依赖

---

#### 9. 多语言支持
**需求描述**: 支持中英文切换

**实现要点**:
- 使用 Flask-Babel 扩展
- 创建语言文件目录 `translations/`
- 提取所有需要翻译的文本
- 在 [`templates/base.html`](templates/base.html:1) 添加语言切换按钮
- 在session中保存用户的语言偏好

**涉及文件**:
- `extensions.py` - 初始化Flask-Babel
- `templates/base.html` - 添加语言切换
- `translations/` - 新建翻译文件目录
- 所有模板文件 - 使用翻译标记

---

#### 10. 邮件通知系统
**需求描述**: 重要操作时发送邮件通知

**实现要点**:
- 扩展 [`services/email_service.py`](services/email_service.py:1) 添加通知方法
- 通知场景:
  - 账户被禁用/启用
  - 密码被修改
  - 登录异常(异地登录)
  - 分析任务完成(长时间运行的任务)
- 在用户设置中允许开启/关闭邮件通知
- 使用异步任务队列(Celery)发送邮件,避免阻塞

**涉及文件**:
- `services/email_service.py` - 添加通知方法
- `blueprints/auth.py` - 在相关操作中发送通知
- `core/auth.py` - 添加通知偏好设置字段

---

## 🔧 技术优化建议

### 11. 缓存机制
**需求描述**: 使用Redis缓存提高性能

**实现要点**:
- 使用 Flask-Caching 扩展
- 缓存内容:
  - 用户会话信息
  - 分析结果(短期缓存)
  - 统计数据(定时更新)
- 在 [`config.py`](config.py:1) 添加Redis配置
- 在高频访问的API中使用缓存

**涉及文件**:
- `extensions.py` - 初始化Flask-Caching
- `config.py` - 添加缓存配置
- `blueprints/admin.py` - 缓存统计数据
- `requirements.txt` - 添加redis和flask-caching

---

### 12. API限流
**需求描述**: 防止API被滥用

**实现要点**:
- 使用 Flask-Limiter 扩展
- 限流规则:
  - 登录接口: 5次/分钟
  - 发送验证码: 1次/分钟
  - 分析接口: 10次/分钟
  - 其他接口: 100次/分钟
- 超过限制返回429状态码
- 在响应头中返回剩余次数

**涉及文件**:
- `extensions.py` - 初始化Flask-Limiter
- `blueprints/auth.py` - 添加限流装饰器
- `blueprints/analysis.py` - 添加限流装饰器
- `requirements.txt` - 添加flask-limiter

---

### 13. 单元测试
**需求描述**: 添加完整的单元测试

**实现要点**:
- 创建 `tests/` 目录
- 使用 pytest 框架
- 测试覆盖:
  - 用户认证功能
  - 数据分析功能
  - 管理后台功能
  - 邮件服务
- 使用测试数据库
- 配置CI/CD自动运行测试

**涉及文件**:
- `tests/` - 新建测试目录
- `tests/test_auth.py` - 认证测试
- `tests/test_analysis.py` - 分析测试
- `tests/test_admin.py` - 管理后台测试
- `requirements.txt` - 添加pytest依赖

---

## 📝 实现建议

### 如何使用本文档

1. **选择优化项目**: 根据优先级和实际需求选择要实现的功能
2. **阅读实现要点**: 了解功能的核心实现逻辑
3. **查看涉及文件**: 确定需要修改的文件
4. **模块化开发**: 每个功能都是独立的,可以单独实现
5. **测试验证**: 实现后进行充分测试

### 给AI的提示词模板

当需要AI实现某个功能时,可以使用以下提示词格式:

```
请为STATAU项目实现[功能名称]功能。

参考文档: 下一步优化建议.md 中的第[X]项

要求:
1. 遵循项目现有的架构模式(三层架构)
2. 代码风格与现有代码保持一致
3. 添加详细的注释和文档字符串
4. 确保功能的安全性和稳定性

涉及的文件:
- [列出需要修改的文件]

实现要点:
- [列出关键实现步骤]
```

### 示例提示词

```
请为STATAU项目实现密码重置功能。

参考文档: 下一步优化建议.md 中的第1项

要求:
1. 遵循项目现有的架构模式(三层架构)
2. 使用现有的邮件服务(services/email_service.py)
3. 添加详细的注释和文档字符串
4. 确保重置token的安全性(有效期、一次性使用)

涉及的文件:
- blueprints/auth.py - 添加重置密码API
- templates/base.html - 添加忘记密码链接
- templates/reset_password.html - 新建重置密码页面
- services/email_service.py - 添加发送重置邮件方法

实现要点:
1. 生成带时效性的重置token(使用itsdangerous库)
2. 发送包含重置链接的邮件
3. 验证token并允许用户设置新密码
4. 重置成功后使token失效
```

---

## ⚠️ 注意事项

1. **保持架构一致性**: 所有新功能都应遵循现有的三层架构
2. **安全第一**: 涉及用户数据的功能必须考虑安全性
3. **向后兼容**: 新功能不应破坏现有功能
4. **文档同步**: 实现新功能后及时更新相关文档
5. **测试充分**: 每个新功能都应进行充分测试

---

## 📞 技术支持

如有问题,请查看:
- 项目主文档: [`README.md`](README.md:1)
- 架构文档: [`ARCHITECTURE.md`](ARCHITECTURE.md:1)
- 邮箱验证功能说明: [`邮箱验证功能说明.md`](邮箱验证功能说明.md:1)
- 管理后台使用说明: [`管理后台使用说明.md`](管理后台使用说明.md:1)

---

**文档版本**: 1.0  
**最后更新**: 2026-01-20
