# 分析页面模块化重构说明

## 📋 重构概述

本次重构将原有的混乱的 [`analysis.html`](../templates/analysis.html) 页面进行了彻底的模块化改造，将不同功能拆分为独立的前端模块，每个模块拥有自己独立的HTML、CSS和JavaScript代码，互不干扰。

## 🎯 重构目标

1. **模块独立性**：每个功能模块完全独立，拥有自己的配置面板、结果展示区和JavaScript逻辑
2. **代码清晰性**：消除通用配置和特定配置混杂的问题，每个模块的代码一目了然
3. **易于维护**：修改某个功能不会影响其他功能，即使出bug也不会互相影响
4. **易于扩展**：添加新功能只需创建新的模块文件，不需要修改主框架

## 📁 新的文件结构

```
templates/
├── analysis.html                          # 主分析页面框架（新版）
├── analysis_old_backup.html              # 原版备份
├── analysis_new.html                     # 新版源文件（可删除）
└── analysis_modules/                     # 模块目录
    ├── descriptive.html                  # 描述性统计模块
    ├── correlation.html                  # 相关性分析模块
    ├── vif.html                          # VIF检验模块
    ├── regression.html                   # 回归模型模块
    └── model_test.html                   # 模型检验模块
```

## 🔧 模块详细说明

### 1. 描述性统计模块 ([`descriptive.html`](../templates/analysis_modules/descriptive.html))

**功能**：生成变量的描述性统计表格

**独立组件**：
- 变量选择区（多选checkbox）
- 统计量选择（Mean, Std, Min, Max, Median, N）
- 格式设置（小数位、表格标题）
- 独立的运行按钮和结果展示区

**JavaScript函数**：
- `initDescriptiveModule(columns)` - 初始化模块
- `runDescriptiveAnalysis()` - 执行分析
- `toggleModulePanel('descriptive')` - 折叠/展开面板

### 2. 相关性分析模块 ([`correlation.html`](../templates/analysis_modules/correlation.html))

**功能**：计算变量间的Pearson相关系数矩阵

**独立组件**：
- 变量选择区（至少2个变量）
- 格式设置
- 说明信息（显著性标注规则）
- 独立的运行按钮和结果展示区

**JavaScript函数**：
- `initCorrelationModule(columns)` - 初始化模块
- `runCorrelationAnalysis()` - 执行分析

### 3. VIF检验模块 ([`vif.html`](../templates/analysis_modules/vif.html))

**功能**：检验变量间的多重共线性

**独立组件**：
- 变量选择区（至少2个变量）
- 格式设置
- VIF判断标准说明
- 独立的运行按钮和结果展示区

**JavaScript函数**：
- `initVIFModule(columns)` - 初始化模块
- `runVIFAnalysis()` - 执行分析

### 4. 回归模型模块 ([`regression.html`](../templates/analysis_modules/regression.html))

**功能**：执行各类回归分析（OLS, FE, RE, Pooled, Logit, Probit）

**独立组件**：
- 因变量/自变量/控制变量选择
- 面板数据设置（Entity ID, Time ID, 固定效应变量）
- 标准误设置（IID, Robust, Cluster）
- 自定义表格底行
- 导出统计量选择
- 格式高级配置
- 新建/追加两个运行按钮
- 原始输出查看模态框

**JavaScript函数**：
- `initRegressionModule(columns)` - 初始化模块
- `setRegressionMethod(method)` - 设置回归方法（ols/fe/re/pooled/logit/probit）
- `runRegressionAnalysis(actionType)` - 执行分析（new/append）
- `toggleRegressionClusterVar()` - 切换聚类变量显示
- `addRegressionCustomRow()` - 添加自定义行
- `showRegressionRaw()` - 显示原始输出

**全局变量**：
- `regressionCurrentMethod` - 当前回归方法
- `regressionLastRawOutput` - 最后的原始输出

### 5. 模型检验模块 ([`model_test.html`](../templates/analysis_modules/model_test.html))

**功能**：执行F检验和Hausman检验

**独立组件**：
- 因变量/自变量/控制变量选择
- 面板数据设置（必须）
- Hausman检验特定设置（sigmamore选项）
- 格式设置
- 独立的运行按钮和结果展示区

**JavaScript函数**：
- `initTestModule(columns)` - 初始化模块
- `setTestMethod(method)` - 设置检验方法（f_test/hausman）
- `runModelTest()` - 执行检验
- `displayTestResult(result, testType)` - 显示检验结果

**全局变量**：
- `testCurrentMethod` - 当前检验方法

## 🔄 主框架说明 ([`analysis.html`](../templates/analysis.html))

### 核心功能

1. **文件上传**：统一的文件上传组件，上传成功后初始化所有模块
2. **模块切换**：通过左侧导航栏切换不同的功能模块
3. **数据预览**：统一的数据预览模态框

### 全局变量

```javascript
window.currentFilename = "";  // 当前上传的文件名（全局可访问）
let columnNames = [];         // 数据列名数组
let currentActiveModule = "regression";  // 当前激活的模块
```

### 核心函数

```javascript
// 初始化所有模块
function initAllModules(columns) {
    if (typeof initDescriptiveModule === 'function') initDescriptiveModule(columns);
    if (typeof initCorrelationModule === 'function') initCorrelationModule(columns);
    if (typeof initVIFModule === 'function') initVIFModule(columns);
    if (typeof initRegressionModule === 'function') initRegressionModule(columns);
    if (typeof initTestModule === 'function') initTestModule(columns);
}

// 切换模块
function switchModule(moduleName, method) {
    // 更新导航栏激活状态
    // 隐藏所有模块
    // 显示目标模块
    // 设置具体方法（如果需要）
}
```

### 模块显隐机制

使用CSS类控制模块显隐：

```css
.analysis-module { display: none; }
.analysis-module.active { display: block; }
```

通过JavaScript动态添加/移除 `active` 类来切换模块。

## 🎨 样式设计

### 统一的样式类

- `.analysis-module` - 模块容器
- `.var-list-container` - 变量列表容器（统一高度160px）
- `.analysis-container` - 整体布局容器
- `.content-area` - 右侧内容区
- `#sidebar` - 左侧导航栏

### 模块特定样式

每个模块的样式都在主框架的 `<style>` 标签中定义，保持统一风格。

## 🔌 后端接口

所有模块使用相同的后端接口，无需修改：

- `POST /upload` - 文件上传
- `POST /analyze` - 执行分析
- `GET /preview` - 数据预览
- `POST /f_test` - F检验
- `POST /hausman_test` - Hausman检验

## ✅ 优势对比

### 原版问题

1. ❌ 所有功能混在一个文件中，超过900行代码
2. ❌ 通过显隐控制切换功能，逻辑复杂
3. ❌ 变量名冲突风险高（如 `x-var-container` 被多个功能共用）
4. ❌ 修改一个功能可能影响其他功能
5. ❌ 难以定位bug和维护

### 新版优势

1. ✅ 每个功能独立文件，代码清晰
2. ✅ 模块间完全隔离，互不影响
3. ✅ 变量名带模块前缀（如 `descriptive-var-container`），无冲突
4. ✅ 修改某个模块不影响其他模块
5. ✅ 易于定位问题和扩展新功能

## 📝 添加新模块的步骤

1. 在 `templates/analysis_modules/` 创建新的HTML文件
2. 定义模块容器：`<div id="module-新模块名" class="analysis-module">`
3. 实现初始化函数：`function init新模块Module(columns) { ... }`
4. 实现运行函数：`function run新模块Analysis() { ... }`
5. 在主框架的 `initAllModules()` 中添加初始化调用
6. 在左侧导航栏添加入口链接
7. 在主框架中 `{% include %}` 新模块文件

## 🔧 维护建议

1. **保持模块独立**：不要在模块间共享变量或函数
2. **统一命名规范**：所有ID和函数名都带模块前缀
3. **文档同步更新**：添加新功能时更新本文档
4. **测试隔离性**：修改某个模块后，测试其他模块是否正常工作

## 🚀 未来扩展

可以轻松添加的新模块：

- 异质性分析模块
- 中介效应模块
- 调节效应模块
- 稳健性检验模块
- 工具变量回归模块

每个新模块只需创建一个独立的HTML文件，不会影响现有功能。

## 📌 注意事项

1. **备份文件**：原版已备份为 [`analysis_old_backup.html`](../templates/analysis_old_backup.html)
2. **后端兼容**：新版前端完全兼容现有后端接口，无需修改后端代码
3. **浏览器兼容**：使用标准HTML5/CSS3/ES6，兼容现代浏览器
4. **Bootstrap依赖**：依赖Bootstrap 5的模态框和折叠组件

## 🎉 总结

本次重构彻底解决了原版代码混乱的问题，实现了真正的模块化设计。每个功能模块都是独立的、自包含的，大大提高了代码的可维护性和可扩展性。
