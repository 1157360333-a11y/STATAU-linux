# 随机效应和混合效应模型功能说明

## 📋 更新概述

本次更新为STATAU平台新增了**随机效应模型（Random Effects）**和**混合效应模型（Pooled OLS）**功能，进一步完善了面板数据分析能力。

## 🎯 新增功能

### 1. 随机效应模型（RE）

**特点：**
- 假设个体效应与解释变量不相关
- 使用GLS（广义最小二乘）估计
- 适用于个体效应为随机变量的情况
- 自动添加常数项

**使用场景：**
- 当个体效应与解释变量不相关时
- 需要估计时不变变量的系数时
- Hausman检验不拒绝原假设时

**代码示例：**
```python
from core.models import StataModel

model = StataModel(
    df, 
    y_var='y', 
    x_vars=['x1', 'x2'], 
    method='re',
    panel_ids={'entity': 'firm_id', 'time': 'year'},
    se_options={'type': 'robust'}
)
result = model.fit(decimals=3)
```

### 2. 混合效应模型（Pooled OLS）

**特点：**
- 忽略面板数据结构，将所有观测视为独立
- 使用普通OLS估计
- 可以作为基准模型与FE/RE比较
- 自动添加常数项

**使用场景：**
- 作为基准模型进行比较
- F检验的对照组（vs 固定效应）
- 个体效应不显著时

**代码示例：**
```python
from core.models import StataModel

model = StataModel(
    df, 
    y_var='y', 
    x_vars=['x1', 'x2'], 
    method='pooled',
    panel_ids={'entity': 'firm_id', 'time': 'year'},
    se_options={'type': 'cluster', 'cluster_var': 'firm_id'}
)
result = model.fit(decimals=3)
```

## 🔧 技术实现

### 后端实现（core/models.py）

1. **新增方法：**
   - `_fit_random_effects()`: 随机效应模型估计
   - `_fit_pooled_ols()`: 混合OLS模型估计
   - `_get_panel_coeffs()`: 统一的面板模型系数提取（支持FE/RE/Pooled）

2. **关键特性：**
   - 使用`linearmodels.panel.RandomEffects`进行RE估计
   - 使用`linearmodels.panel.PooledOLS`进行Pooled估计
   - 支持稳健标准误和聚类标准误
   - 自动剔除singleton（只出现一次的个体）
   - 自动添加常数项

### 前端实现（templates/analysis.html）

1. **UI更新：**
   - 左侧导航栏新增"🔀 随机效应模型"和"📊 混合效应模型"选项
   - 自动显示面板数据设置区域
   - 参数校验确保必填项完整

2. **JavaScript逻辑：**
   - 更新`selectMethod()`函数识别新模型
   - 更新`isRegression`判断逻辑
   - 更新参数校验逻辑

### 路由处理（blueprints/analysis.py）

- 无需修改路由逻辑，现有的`/analyze`接口自动支持新模型
- 通过`method`参数区分不同模型类型

## 📊 模型对比

| 特性 | 固定效应（FE） | 随机效应（RE） | 混合效应（Pooled） |
|------|---------------|---------------|-------------------|
| 个体效应 | 固定参数 | 随机变量 | 忽略 |
| 常数项 | 被吸收 | 估计 | 估计 |
| 时不变变量 | 无法估计 | 可以估计 | 可以估计 |
| 效率 | 一致但可能低效 | 有效（假设成立时） | 可能有偏 |
| 适用场景 | 个体效应与X相关 | 个体效应与X不相关 | 无个体效应 |

## 🧪 模型选择建议

### 选择流程：

1. **第一步：F检验（FE vs Pooled）**
   - 检验是否存在个体效应
   - 如果拒绝原假设 → 存在个体效应，继续第二步
   - 如果不拒绝 → 使用Pooled OLS

2. **第二步：Hausman检验（FE vs RE）**
   - 检验个体效应是否与解释变量相关
   - 如果拒绝原假设 → 使用固定效应（FE）
   - 如果不拒绝 → 使用随机效应（RE）

### 实际应用：

```python
# 1. 先运行F检验
f_result = ModelTests.f_test_fe_vs_pooled(
    df, y_var='y', x_vars=['x1', 'x2'],
    entity_col='firm_id', time_col='year'
)

# 2. 如果F检验显著，再运行Hausman检验
if f_result['p_value'] < 0.05:
    hausman_result = ModelTests.hausman_test(
        df, y_var='y', x_vars=['x1', 'x2'],
        entity_col='firm_id', time_col='year',
        sigmamore=True  # 推荐使用sigmamore选项
    )
```

## 📝 使用注意事项

### 1. 面板数据要求
- 必须设置Entity ID（个体标识）和Time ID（时间标识）
- 数据必须是平衡或非平衡面板格式
- 自动剔除只出现一次的个体（singleton）

### 2. 标准误选项
- **普通标准误（iid）**：假设同方差且无自相关
- **稳健标准误（robust）**：允许异方差
- **聚类标准误（cluster）**：允许组内相关

### 3. 固定效应变量
- RE和Pooled模型不需要选择固定效应变量
- FE模型仍需选择要固定的维度

### 4. 常数项处理
- RE和Pooled模型会自动添加常数项
- FE模型的常数项被个体固定效应吸收

## 🔍 输出结果说明

### 统计量说明：

- **N**: 观测数量
- **R²**: 决定系数
  - FE: R²-inclusive（包含固定效应）
  - RE: R²-overall（总体R²）
  - Pooled: 标准R²
- **Adj-R²**: 调整后的R²
- **F-stat**: F统计量

### 系数表格：

- 系数值后的星号表示显著性水平
  - `***`: p < 0.01
  - `**`: p < 0.05
  - `*`: p < 0.1
- 括号内为标准误（或t值，可切换）

## 🎓 理论背景

### 随机效应模型

**模型形式：**
```
y_it = α + β'X_it + u_i + ε_it
```
其中：
- `u_i ~ N(0, σ²_u)`: 个体随机效应
- `ε_it ~ N(0, σ²_ε)`: 随机误差项
- 假设：`Cov(u_i, X_it) = 0`

**估计方法：**
使用GLS（广义最小二乘），通过变换消除个体效应的影响。

### 混合效应模型

**模型形式：**
```
y_it = α + β'X_it + ε_it
```

**估计方法：**
标准OLS，但需要考虑面板数据的聚类结构（使用聚类标准误）。

## 📚 参考资料

1. Wooldridge, J. M. (2010). *Econometric Analysis of Cross Section and Panel Data*. MIT Press.
2. Baltagi, B. H. (2013). *Econometric Analysis of Panel Data*. John Wiley & Sons.
3. Stata Manual: `xtreg` command documentation

## 🔗 相关功能

- [固定效应模型](../README.md#固定效应模型)
- [F检验说明](./豪斯曼检验修复说明.md)
- [Hausman检验说明](./豪斯曼检验sigmamore选项说明.md)
- [模型检验控制变量修复](./模型检验控制变量修复说明.md)

---

**更新日期**: 2026-01-22  
**版本**: v1.0
