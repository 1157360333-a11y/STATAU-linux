# 模型检验控制变量修复说明

## 问题描述

在F检验和豪斯曼检验中，手动输入的控制变量无法被正确识别和使用，导致检验结果不准确。

## 问题根源

在[`templates/analysis.html`](templates/analysis.html:722)的`runModelTest()`函数中，变量收集逻辑存在缺陷：

### 修复前的代码（错误）

```javascript
function runModelTest(testType, btn, spinner) {
    // 收集参数
    const y_var = document.getElementById('y-var-select').value;
    const xVars = Array.from(document.querySelectorAll('.x-box:checked')).map(e=>e.value);
    const cVars = Array.from(document.querySelectorAll('.c-box:checked')).map(e=>e.value);
    const panel_entity = document.getElementById('fe-entity-select').value;
    const panel_time = document.getElementById('fe-time-select').value;
    const decimals = document.getElementById('decimal-input').value;
    
    // 校验
    if (!y_var) { alert("请选择因变量 Y"); return; }
    if (xVars.length === 0 && cVars.length === 0) { alert("请至少选择一个自变量"); return; }
    if (!panel_entity || !panel_time) { alert("模型检验必须设置 Entity 和 Time ID"); return; }
    
    const payload = {
        filename: currentFilename,
        y_var: y_var,
        x_vars: xVars.concat(cVars),  // ❌ 缺少手动输入的控制变量
        panel_entity: panel_entity,
        panel_time: panel_time,
        decimals: decimals
    };
    // ...
}
```

**问题：**
- 只收集了通过复选框选择的自变量（`.x-box`）和控制变量（`.c-box`）
- 完全忽略了手动输入框（`#manual-controls`）中的控制变量
- 导致用户手动输入的控制变量在模型检验中不生效

### 对比：回归分析的正确实现

在同一文件的[`runAnalysis()`](templates/analysis.html:568)函数中，回归分析正确处理了手动输入的控制变量：

```javascript
const xVars = Array.from(document.querySelectorAll('.x-box:checked')).map(e=>e.value);
const cVars = Array.from(document.querySelectorAll('.c-box:checked')).map(e=>e.value);
const manual = document.getElementById('manual-controls').value;  // ✅ 读取手动输入
payload.x_vars = xVars.concat(cVars);
payload.manual_controls = manual;  // ✅ 传递给后端处理
```

后端在[`blueprints/analysis.py`](blueprints/analysis.py:243)中进一步处理：

```python
# 处理手动输入的控制变量
if manual_controls:
    extras = [c.strip() for c in manual_controls.replace(',', ' ').split() if c.strip()]
    valid_extras = [c for c in extras if c in df.columns]
    x_vars.extend(valid_extras)
```

## 修复方案

### 修复后的代码（正确）

```javascript
function runModelTest(testType, btn, spinner) {
    // 收集参数
    const y_var = document.getElementById('y-var-select').value;
    const xVars = Array.from(document.querySelectorAll('.x-box:checked')).map(e=>e.value);
    const cVars = Array.from(document.querySelectorAll('.c-box:checked')).map(e=>e.value);
    const manual = document.getElementById('manual-controls').value;  // ✅ 读取手动输入
    const panel_entity = document.getElementById('fe-entity-select').value;
    const panel_time = document.getElementById('fe-time-select').value;
    const decimals = document.getElementById('decimal-input').value;
    
    // ✅ 处理手动输入的控制变量
    let allXVars = xVars.concat(cVars);
    if (manual) {
        const manualVars = manual.split(/[\s,]+/).filter(v => v.trim() !== '');
        allXVars = allXVars.concat(manualVars);
    }
    
    // 校验
    if (!y_var) { alert("请选择因变量 Y"); return; }
    if (allXVars.length === 0) { alert("请至少选择一个自变量或控制变量"); return; }
    if (!panel_entity || !panel_time) { alert("模型检验必须设置 Entity 和 Time ID"); return; }
    
    const payload = {
        filename: currentFilename,
        y_var: y_var,
        x_vars: allXVars,  // ✅ 包含所有变量（复选框 + 手动输入）
        panel_entity: panel_entity,
        panel_time: panel_time,
        decimals: decimals
    };
    // ...
}
```

## 修复要点

1. **读取手动输入框**：
   ```javascript
   const manual = document.getElementById('manual-controls').value;
   ```

2. **解析手动输入的变量**：
   ```javascript
   const manualVars = manual.split(/[\s,]+/).filter(v => v.trim() !== '');
   ```
   - 支持空格和逗号分隔
   - 过滤空字符串

3. **合并所有变量**：
   ```javascript
   let allXVars = xVars.concat(cVars);
   if (manual) {
       allXVars = allXVars.concat(manualVars);
   }
   ```

4. **更新校验提示**：
   ```javascript
   if (allXVars.length === 0) { 
       alert("请至少选择一个自变量或控制变量"); 
       return; 
   }
   ```

## 后端处理

后端代码无需修改，因为：
- F检验接口（[`/f_test`](blueprints/analysis.py:426)）直接接收`x_vars`数组
- Hausman检验接口（[`/hausman_test`](blueprints/analysis.py:502)）也直接接收`x_vars`数组
- 前端已经将所有变量（包括手动输入的）合并到`x_vars`中传递给后端

## 测试验证

### 测试场景

1. **只使用复选框选择变量**
   - 勾选自变量：`DIGI`
   - 勾选控制变量：`urban`, `gov`
   - 结果：✅ 正常工作

2. **只使用手动输入**
   - 手动输入：`DIGI urban gov edu hum`
   - 结果：✅ 所有变量都被识别

3. **混合使用**
   - 勾选自变量：`DIGI`
   - 手动输入：`urban gov edu hum retail med fdi structure`
   - 结果：✅ 所有变量都被正确合并

4. **手动输入支持多种分隔符**
   - 空格分隔：`urban gov edu`
   - 逗号分隔：`urban,gov,edu`
   - 混合分隔：`urban, gov edu`
   - 结果：✅ 都能正确解析

## 影响范围

### 修复的功能
- ✅ F检验（固定效应 vs 混合OLS）
- ✅ Hausman检验（固定效应 vs 随机效应）

### 不受影响的功能
- ✅ 回归模型（OLS、FE、Logit、Probit）- 原本就正确
- ✅ 描述性统计、相关性分析、VIF检验 - 不使用控制变量

## 修复文件

- [`templates/analysis.html`](templates/analysis.html:722) - `runModelTest()`函数

## 修复日期

2026-01-22

## 修复人员

Kilo Code

## 相关文档

- [豪斯曼检验修复说明.md](豪斯曼检验修复说明.md) - 随机效应模型常数项修复
- [豪斯曼检验sigmamore选项说明.md](豪斯曼检验sigmamore选项说明.md) - sigmamore选项实现
