# STATAU 环境切换说明

## 概述

本项目支持**本地版**和**服务器版**两种运行模式，通过环境变量 `RUN_MODE` 即可轻松切换，无需修改代码。

---

## 前置准备

### 安装必需的依赖包

```bash
# 安装环境切换所需的依赖
pip install python-dotenv flask-session
```

**说明**：
- `python-dotenv`：自动加载 .env 文件（推荐安装）
- `flask-session`：服务器版文件系统 Session（服务器部署必需）

详细说明请查看 [依赖安装说明.md](依赖安装说明.md)

---

## 快速开始

### 1. 创建配置文件

首次使用时，复制 `.env.example` 文件为 `.env`：

```bash
# Windows
copy .env.example .env

# Linux/Mac
cp .env.example .env
```

### 2. 设置运行模式

编辑 `.env` 文件，修改 `RUN_MODE` 的值：

```bash
# 本地版（开发调试）
RUN_MODE=local

# 服务器版（生产部署）
RUN_MODE=server
```

### 3. 启动应用

```bash
python app.py
```

**就这么简单！** 应用会自动根据 `RUN_MODE` 加载对应的配置。

---

## 两种模式的区别

| 特性 | 本地版 (`RUN_MODE=local`) | 服务器版 (`RUN_MODE=server`) |
|------|---------------------------|------------------------------|
| **配置类** | `DevelopmentConfig` | `ServerConfig` |
| **调试模式** | ✅ 启用 (`DEBUG=True`) | ❌ 禁用 (`DEBUG=False`) |
| **绑定地址** | `127.0.0.1`（仅本地访问） | `0.0.0.0`（允许外部访问） |
| **Session 存储** | 内存（默认） | 文件系统 (`./flask_session/`) |
| **静态文件缓存** | ❌ 禁用 | ✅ 启用 |
| **适用场景** | 本地开发、实时调试 | 服务器部署、生产环境 |

---

## 详细配置说明

### 方式一：使用 `.env` 文件（推荐）

编辑 `.env` 文件：

```bash
# 运行模式（必填）
RUN_MODE=local  # 或 server

# 以下为可选配置
FLASK_ENV=development
DATABASE_URL=sqlite:///instance/statau.db
SECRET_KEY=your-secret-key
```

### 方式二：使用环境变量

#### Windows (CMD)
```cmd
set RUN_MODE=local
python app.py
```

#### Windows (PowerShell)
```powershell
$env:RUN_MODE="local"
python app.py
```

#### Linux/Mac
```bash
export RUN_MODE=local
python app.py

# 或者一行命令
RUN_MODE=local python app.py
```

---

## 常见使用场景

### 场景 1：本地开发调试

```bash
# 1. 设置为本地模式
RUN_MODE=local

# 2. 启动应用
python app.py

# 3. 访问 http://localhost:5000
# 此时会自动启用调试模式，代码修改后自动重载
```

### 场景 2：服务器部署

```bash
# 1. 设置为服务器模式
RUN_MODE=server

# 2. 使用 Gunicorn 启动（推荐）
gunicorn -w 4 -b 0.0.0.0:5000 "app:create_app()"

# 或者直接运行（不推荐生产环境）
python app.py
```

### 场景 3：临时切换模式测试

```bash
# 不修改 .env 文件，直接在命令行指定
RUN_MODE=server python app.py
```

---

## 配置文件结构

```
STATAU-linux/
├── .env.example          # 配置模板（提交到 Git）
├── .env                  # 实际配置（不提交到 Git）
├── config.py             # 配置类定义
├── app.py                # 应用入口
└── 环境切换说明.md       # 本文档
```

---

## 注意事项

### 1. `.env` 文件安全

- ✅ **提交** `.env.example` 到 Git（作为模板）
- ❌ **不要提交** `.env` 到 Git（包含敏感信息）
- 确保 `.gitignore` 中包含 `.env`

### 2. 服务器版 Session 目录

服务器版会自动创建 `./flask_session/` 目录存储 Session 数据，确保：
- 该目录有写入权限
- 定期清理过期 Session 文件

### 3. 生产环境建议

- 使用 Gunicorn 或 uWSGI 作为 WSGI 服务器
- 配置 Nginx 作为反向代理
- 设置强随机的 `SECRET_KEY`
- 使用 PostgreSQL 或 MySQL 替代 SQLite

---

## 故障排查

### 问题 1：配置未生效

**症状**：修改了 `.env` 文件，但应用仍使用旧配置

**解决方案**：
1. 确认 `.env` 文件在项目根目录
2. 重启应用（`Ctrl+C` 后重新运行 `python app.py`）
3. 检查是否有环境变量覆盖了 `.env` 的设置

### 问题 2：Session 数据丢失

**症状**：服务器版用户频繁掉线

**解决方案**：
1. 确认 `RUN_MODE=server`
2. 检查 `./flask_session/` 目录是否存在且有写入权限
3. 查看应用启动日志，确认显示 "服务器版 Session 已启用"

### 问题 3：调试模式无法关闭

**症状**：服务器版仍显示调试信息

**解决方案**：
1. 确认 `RUN_MODE=server`（不是 `local`）
2. 检查是否有 `FLASK_ENV=development` 覆盖了配置
3. 查看启动日志，确认加载的是 `ServerConfig`

---

## 技术实现原理

### 配置加载流程

```
启动应用
  ↓
读取环境变量 RUN_MODE
  ↓
┌─────────────┬─────────────┐
│ RUN_MODE    │ 加载配置    │
├─────────────┼─────────────┤
│ local       │ Development │
│ server      │ Server      │
│ (未设置)    │ Development │
└─────────────┴─────────────┘
  ↓
应用配置类的所有设置
  ↓
启动 Flask 应用
```

### 核心代码

**config.py**
```python
def get_config(config_name=None):
    if config_name is None:
        run_mode = os.environ.get('RUN_MODE', '').lower()
        if run_mode == 'local':
            config_name = 'development'
        elif run_mode == 'server':
            config_name = 'server'
    return config_map.get(config_name, DevelopmentConfig)
```

**app.py**
```python
def create_app(config_class=None):
    if config_class is None:
        config_class = get_config()  # 自动选择配置
    app.config.from_object(config_class)
    # ...
```

---

## 扩展阅读

- [Flask 配置管理最佳实践](https://flask.palletsprojects.com/en/2.3.x/config/)
- [环境变量使用指南](https://12factor.net/config)
- [Gunicorn 部署文档](https://docs.gunicorn.org/en/stable/deploy.html)

---

## 更新日志

- **2026-01-31**：初始版本，实现基于 `RUN_MODE` 的环境切换
