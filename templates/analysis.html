{% extends "base.html" %}

{% block title %}æ•°æ®åˆ†æ{% endblock %}

{% block styles %}
<style>
    /* åˆ†æé¡µé¢å…¨å±€å¸ƒå±€ */
    .analysis-container { display: flex !important; flex-direction: row !important; height: calc(100vh - 56px); width: 100%; overflow: hidden; }
    
    /* å·¦ä¾§å¯¼èˆªæ  */
    #sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #1a252f; }
    .nav-link-sidebar { color: #bdc3c7; cursor: pointer; padding: 12px 20px; display: block; text-decoration: none; transition: 0.2s;}
    .nav-link-sidebar:hover, .nav-link-sidebar.active { color: white; background-color: #34495e; border-left: 4px solid #1abc9c; }
    .sidebar-header { font-size: 0.85rem; font-weight: bold; color: #6c757d; padding: 10px 20px 5px 20px; text-transform: uppercase; letter-spacing: 1px; }

    /* å³ä¾§å†…å®¹åŒº */
    .content-area { flex: 1; padding: 20px; height: 100%; overflow-y: auto; background-color: #f4f6f9; position: relative; }
    
    /* å˜é‡åˆ—è¡¨å®¹å™¨ */
    .var-list-container { border: 1px solid #ced4da; height: 160px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px; }
    
    /* è¡¨æ ¼æ ·å¼ */
    .table-editable-container { text-align: center; margin-top: 20px; overflow-x: auto; }
    .table-title-input { border: none; background: transparent; font-size: 1.2em; font-weight: bold; text-align: center; width: 80%; border-bottom: 1px dashed #ccc; }
    .table-title-input:focus { outline: none; border-bottom: 1px solid #000; }
    
    /* å­¦æœ¯è¡¨æ ¼åŸºç¡€æ ·å¼ */
    .academic-table { border-collapse: collapse; margin: 0 auto; font-family: "Times New Roman", serif; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-width: 50%; }
    .academic-table td, .academic-table th { padding: 6px 12px; white-space: nowrap; }
    
    /* Loading æ ·å¼ */
    .spinner-border-sm { width: 1rem; height: 1rem; border-width: 0.15em; }

    /* è‡ªå®šä¹‰è¡Œæ ·å¼ */
    .custom-row-item { display: flex; gap: 5px; margin-bottom: 5px; }

    /* é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
    #previewModal .modal-body { max-height: 70vh; overflow-y: auto; }
    #previewModal .table td, #previewModal .table th { white-space: nowrap; }

    /* å·¥å…·ç±»ï¼šç”¨äºJSæ§åˆ¶æ˜¾éš */
    .d-none-custom { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <div id="sidebar">
        <!-- æ–°å¢åŠŸèƒ½åŒº -->
        <div class="sidebar-header">åŸºç¡€åˆ†æ</div>
        <a class="nav-link-sidebar" onclick="selectMethod('desc')">ğŸ“Š æè¿°æ€§ç»Ÿè®¡</a>
        <a class="nav-link-sidebar" onclick="selectMethod('corr')">ğŸ”— ç›¸å…³æ€§åˆ†æ</a>
        <a class="nav-link-sidebar" onclick="selectMethod('vif')">âš ï¸ VIF å…±çº¿æ€§æ£€éªŒ</a>

        <hr style="border-color: #4b5d6b; margin: 10px 0;">

        <!-- åŸæœ‰å›å½’åŒº -->
        <div class="sidebar-header">å›å½’æ¨¡å‹</div>
        <a class="nav-link-sidebar active" onclick="selectMethod('ols')">ğŸ“ˆ çº¿æ€§ OLS å›å½’</a>
        <a class="nav-link-sidebar" onclick="selectMethod('fe')">ğŸ—ï¸ å›ºå®šæ•ˆåº”æ¨¡å‹</a>
        <a class="nav-link-sidebar" onclick="selectMethod('logit')">ğŸŸ¢ Logit æ¨¡å‹</a>
        <a class="nav-link-sidebar" onclick="selectMethod('probit')">ğŸ”µ Probit æ¨¡å‹</a>
        <!-- ä¿ç•™å…¶ä»–å…¥å£ -->
        <a class="nav-link-sidebar" onclick="selectMethod('hetero')">å¼‚è´¨æ€§åˆ†æ</a>
        <a class="nav-link-sidebar" onclick="selectMethod('mediation')">ä¸­ä»‹æ•ˆåº”æ¨¡å‹</a>

        <hr style="border-color: #4b5d6b; margin: 10px 0;">

        <!-- æ–°å¢ï¼šæ¨¡å‹æ£€éªŒåŒº -->
        <div class="sidebar-header">æ¨¡å‹æ£€éªŒ</div>
        <a class="nav-link-sidebar" onclick="selectMethod('f_test')">ğŸ”¬ Fæ£€éªŒ (FE vs Pooled)</a>
        <a class="nav-link-sidebar" onclick="selectMethod('hausman')">ğŸ§ª Hausmanæ£€éªŒ (FE vs RE)</a>
    </div>

        <!-- å³ä¾§å†…å®¹ -->
        <div class="content-area">
            {% if not current_user.is_authenticated %}
            <div class="alert alert-warning text-center py-2 mb-3"><small>âš ï¸ æ¸¸å®¢æ¨¡å¼ä¸‹æ— æ³•ä¿å­˜å†å²è®°å½•ã€‚</small></div>
            {% endif %}

        <!-- æ–‡ä»¶ä¸Šä¼  (å®Œå…¨ä¿ç•™åŸåŠŸèƒ½ï¼šé¢„è§ˆæŒ‰é’® + Loading) -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body py-2 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span id="file-status" class="fw-bold text-primary me-2"><i class="bi bi-upload"></i> è¯·å…ˆä¸Šä¼ æ•°æ®</span>
                    <div id="upload-loading" class="spinner-border spinner-border-sm text-primary" style="display:none;"></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <!-- é¢„è§ˆæŒ‰é’®ï¼šå¿…é¡»ä¿ç•™ -->
                    <button id="btn-preview" class="btn btn-sm btn-outline-primary" style="display:none;" onclick="previewData()">é¢„è§ˆæ•°æ®</button>
                    <input type="file" id="fileInput" class="form-control form-control-sm" style="width: auto;" accept=".csv, .xlsx, .dta">
                </div>
            </div>
        </div>

        <!-- é…ç½®é¢æ¿ -->
        <div id="setup-panel" class="card shadow-sm mb-4" style="display:none;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center" onclick="togglePanel()">
                <h6 class="m-0 text-primary fw-bold" id="method-title">å˜é‡é…ç½®</h6>
                <button class="btn btn-sm btn-light" onclick="togglePanel(); event.stopPropagation();">æŠ˜å /å±•å¼€</button>
            </div>
            <div class="card-body" id="config-body" style="display: block;">
                
                <!-- ================== åŒºåŸŸ 1: å˜é‡é€‰æ‹© (åˆ†ä¸º å›å½’æ¨¡å¼ å’Œ ç®€å•æ¨¡å¼) ================== -->
                
                <!-- 1.A å›å½’æ¨¡å¼å˜é‡é€‰æ‹© (Y, X, Control) - åŸæœ‰å¸ƒå±€ -->
                <div id="group-vars-regression">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="small fw-bold">å› å˜é‡ (Y) <span class="text-danger">*</span></label>
                            <select id="y-var-select" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">è‡ªå˜é‡ (X)</label>
                            <div id="x-var-container" class="var-list-container"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">æ§åˆ¶å˜é‡</label>
                            <div id="c-var-container" class="var-list-container"></div>
                        </div>
                        <div class="col-md-12">
                            <input type="text" id="manual-controls" class="form-control form-control-sm" placeholder="æ‰‹åŠ¨è¾“å…¥æ§åˆ¶å˜é‡ (ç©ºæ ¼åˆ†éš”)...">
                        </div>
                    </div>
                </div>

                <!-- 1.B [æ–°å¢] ç®€å•æ¨¡å¼å˜é‡é€‰æ‹© (ç”¨äº æè¿°/ç›¸å…³/VIF) -->
                <div id="group-vars-simple" class="d-none-custom">
                    <div class="row">
                        <div class="col-md-12">
                            <label class="small fw-bold">è¯·é€‰æ‹©åˆ†æå˜é‡ (å¤šé€‰) <span class="text-danger">*</span></label>
                            <div id="simple-var-container" class="var-list-container" style="height: 200px;">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </div>
                            <small class="text-muted">æ­¤å¤„ä¸åŒºåˆ†å› å˜é‡å’Œè‡ªå˜é‡ã€‚</small>
                        </div>
                    </div>
                </div>

                <!-- ================== åŒºåŸŸ 2: æ¨¡å‹ç‰¹å®šè®¾ç½® ================== -->

                <!-- 2.A é¢æ¿ä¸å›ºå®šæ•ˆåº” (ä»… FE æ˜¾ç¤º) - åŸæœ‰å¸ƒå±€ -->
                <div id="fe-specific-settings" class="mt-3 p-3 bg-light rounded border" style="display:none;">
                    <h6 class="fw-bold small text-primary"><i class="bi bi-layers"></i> é¢æ¿ç»“æ„ä¸å›ºå®šæ•ˆåº”è®¾ç½®</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="small fw-bold">ä¸ªä½“ID (Entity) <span class="text-danger">*</span></label>
                            <select id="fe-entity-select" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">æ—¶é—´ID (Time) <span class="text-danger">*</span></label>
                            <select id="fe-time-select" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">é€‰æ‹©è¦å›ºå®šçš„å˜é‡ (å¤šé€‰)</label>
                            <div id="fe-vars-container" class="var-list-container" style="height: 100px;"></div>
                            <small class="text-muted" style="font-size:0.7em">å‹¾é€‰éœ€è¦å›ºå®šçš„ç»´åº¦(å¦‚Industry, Year)</small>
                        </div>
                    </div>
                </div>

                <!-- 2.C Hausmanæ£€éªŒç‰¹å®šè®¾ç½® (ä»… hausman æ˜¾ç¤º) -->
                <div id="hausman-specific-settings" class="mt-3 p-3 bg-light rounded border" style="display:none;">
                    <h6 class="fw-bold small text-primary"><i class="bi bi-gear"></i> Hausmanæ£€éªŒé€‰é¡¹</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sigmamore-checkbox">
                        <label class="form-check-label" for="sigmamore-checkbox">
                            <strong>ä½¿ç”¨sigmamoreé€‰é¡¹</strong> (åŸºäºéšæœºæ•ˆåº”ç»Ÿä¸€æ–¹å·®ä¼°è®¡)
                        </label>
                        <div class="form-text small">
                            å¯ç”¨æ­¤é€‰é¡¹å¯ä»¥è§£å†³åæ–¹å·®çŸ©é˜µä¸æ­£å®šçš„é—®é¢˜ï¼Œå¾—åˆ°ä¸Stataä¸€è‡´çš„æ£€éªŒç»“æœã€‚
                            <br>ä¸å¯ç”¨æ—¶ä½¿ç”¨åŸå§‹åæ–¹å·®çŸ©é˜µï¼Œå¯èƒ½é‡åˆ°"V_b-V_B is not positive definite"è­¦å‘Šã€‚
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <!-- 2.D æ ‡å‡†è¯¯ & è‡ªå®šä¹‰è¡Œ (ä»…å›å½’æ˜¾ç¤º) -->
                <div id="group-se-custom" class="row g-3">
                    <div class="col-md-6">
                        <label class="small fw-bold">æ ‡å‡†è¯¯è®¡ç®—æ–¹å¼ (Cluster/Robust)</label>
                        <select id="se-type-select" class="form-select form-select-sm mb-2" onchange="toggleClusterVar()">
                            <option value="iid">æ™®é€šæ ‡å‡†è¯¯ (IID)</option>
                            <option value="robust">ç¨³å¥æ ‡å‡†è¯¯ (Robust)</option>
                            <option value="cluster">èšç±»æ ‡å‡†è¯¯ (Cluster)</option>
                        </select>
                        <div id="cluster-var-box" style="display:none;">
                            <label class="small text-muted">èšç±»å˜é‡ (Cluster Variable)</label>
                            <select id="cluster-var-select" class="form-select form-select-sm"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold">è‡ªå®šä¹‰è¡¨æ ¼åº•è¡Œ (Custom Rows)</label>
                        <div id="custom-rows-container"></div>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="addCustomRow()">+ æ·»åŠ  (å¦‚ Industry FE: Yes)</button>
                    </div>
                </div>
                
                <!-- åˆ†éš”çº¿ï¼šä»…åœ¨å›å½’æ¨¡å¼æ˜¾ç¤º -->
                <hr class="my-3" id="hr-se-custom">

                <!-- ================== åŒºåŸŸ 3: å¯¼å‡ºä¸æ ¼å¼ (å®Œå…¨ä¿ç•™) ================== -->

                <!-- 3.A å¯¼å‡ºç»Ÿè®¡é‡ (æ ¹æ®æ¨¡å¼åˆ‡æ¢æ˜¾ç¤ºå†…å®¹) -->
                <div class="mb-2">
                    <label class="small fw-bold">å¯¼å‡ºç»Ÿè®¡é‡ (Statistics):</label>
                    <div class="d-flex flex-wrap gap-2">
                        <!-- é€šç”¨ -->
                        <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="nobs" checked disabled><label>N / Count</label></div>
                        
                        <!-- å›å½’ä¸“ç”¨ç»„ -->
                        <span id="stats-group-regression" class="d-flex gap-2">
                            <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="r2" checked id="chk-r2"><label for="chk-r2">RÂ²</label></div>
                            <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="adj_r2" checked id="chk-adj"><label for="chk-adj">Adj-RÂ²</label></div>
                            <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="f_stat" checked id="chk-f"><label for="chk-f">F-stat</label></div>
                            <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="aic" id="chk-aic"><label for="chk-aic">AIC</label></div>
                            <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="bic" id="chk-bic"><label for="chk-bic">BIC</label></div>
                            <div class="form-check"><input class="form-check-input export-opt" type="checkbox" value="ll" id="chk-ll"><label for="chk-ll">Log Likelihood</label></div>
                        </span>

                        <!-- æè¿°ç»Ÿè®¡ä¸“ç”¨ç»„ (é»˜è®¤éšè—) -->
                        <span id="stats-group-desc" class="d-none-custom gap-2">
                            <div class="form-check"><input class="form-check-input desc-opt" type="checkbox" value="mean" checked><label>Mean</label></div>
                            <div class="form-check"><input class="form-check-input desc-opt" type="checkbox" value="std" checked><label>Std.Dev</label></div>
                            <div class="form-check"><input class="form-check-input desc-opt" type="checkbox" value="min" checked><label>Min</label></div>
                            <div class="form-check"><input class="form-check-input desc-opt" type="checkbox" value="max" checked><label>Max</label></div>
                            <div class="form-check"><input class="form-check-input desc-opt" type="checkbox" value="p50"><label>Median</label></div>
                        </span>
                    </div>
                </div>

                <!-- 3.B é«˜çº§æ ¼å¼è®¾ç½® (Accordion) - å®Œå…¨ä¿ç•™ -->
                <div class="accordion mb-3" id="advAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed py-2 bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#advConfig">
                                âš™ï¸ æ ¼å¼é«˜çº§é…ç½® (å°æ•°ä½ã€æ‹¬å·å†…å®¹ã€æ ‡é¢˜)
                            </button>
                        </h2>
                        <div id="advConfig" class="accordion-collapse collapse">
                            <div class="accordion-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <label class="small">æ•°å€¼å°æ•°ä½</label>
                                        <input type="number" id="decimal-input" class="form-control form-control-sm" value="3" min="1" max="6">
                                    </div>
                                    
                                    <!-- æ‹¬å·å†…å®¹é€‰æ‹© (ä»…å›å½’æœ‰æ•ˆï¼Œä½†åœ¨æè¿°ç»Ÿè®¡æ—¶ä¸å½±å“) -->
                                    <div class="col-md-4" id="adv-se-toggle">
                                        <label class="small d-block">æ‹¬å·å†…æ˜¾ç¤ºå†…å®¹ (ä»…å›å½’)</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="se_opt" id="show_se" checked>
                                            <label class="form-check-label small" for="show_se">æ ‡å‡†è¯¯ (SE)</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="se_opt" id="show_t">
                                            <label class="form-check-label small" for="show_t">tå€¼ / zå€¼</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-5">
                                        <label class="small">è¡¨æ ¼æ ‡é¢˜</label>
                                        <input type="text" id="default-title" class="form-control form-control-sm" value="Results">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. è¿è¡ŒæŒ‰é’® -->
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary btn-sm flex-grow-1" id="btn-run-new" onclick="runAnalysis('new')">
                        <span class="spinner-border spinner-border-sm d-none"></span> <span class="btn-text">å¼€å§‹æ–°åˆ†æ</span>
                    </button>
                    <!-- è¿½åŠ æŒ‰é’®ï¼šä»…å›å½’æ¨¡å¼æ˜¾ç¤º -->
                    <button class="btn btn-success btn-sm flex-grow-1" id="btn-run-append" onclick="runAnalysis('append')">
                        <span class="spinner-border spinner-border-sm d-none"></span> <span class="btn-text">è¿½åŠ åˆ°å½“å‰è¡¨</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="result-container" style="display:none; padding-bottom: 50px;">
            <div class="d-flex justify-content-center gap-3 mb-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="togglePanel(true)">é‡æ–°é…ç½®</button>
                <!-- åŸå§‹ç»“æœæŸ¥çœ‹ï¼šæè¿°ç»Ÿè®¡æ¨¡å¼ä¸‹éšè— -->
                <button class="btn btn-sm btn-info text-white" id="btn-show-raw" onclick="showRaw()">æŸ¥çœ‹åŸå§‹è¾“å‡º</button>
            </div>
            <div id="table-output"></div>
        </div>
    </div>
</div>

<!-- åŸå§‹å›å½’ç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="rawModal"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">åŸå§‹å›å½’ç»“æœ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><pre id="raw-text" class="bg-light p-3"></pre></div></div></div></div>

<!-- æ•°æ®é¢„è§ˆæ¨¡æ€æ¡† (å®Œå…¨ä¿ç•™) -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ•°æ®é¢„è§ˆ (å‰10è¡Œ)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // è¾…åŠ©å‡½æ•°ï¼šHTMLè½¬ä¹‰
    function escapeHtml(str) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '/': '&#x2F;' };
        return String(str).replace(/[&<>"'/]/g, (c) => map[c]);
    }

    // å•å…ƒæ ¼æ ¼å¼åŒ–å‡½æ•°ï¼ˆæŒ‰æ–°è§„åˆ™ï¼‰
    function formatCell(value, dtype) {
        if (value === null || value === undefined) return '';
        // æµ®ç‚¹æ•°ç±»å‹ï¼ˆfloat64, float32, ...ï¼‰
        if (dtype.startsWith('float')) {
            let num = Number(value);
            if (isNaN(num)) return String(value);
            if (Math.abs(num) >= 1e6 || (Math.abs(num) <= 1e-4 && num !== 0)) {
                return num.toExponential(2);
            } else {
                return num.toFixed(2);
            }
        } else if (dtype.startsWith('int') || dtype.startsWith('uint')) {
            // æ•´æ•°ç±»å‹
            let num = Number(value);
            if (isNaN(num)) return String(value);
            if (Math.abs(num) >= 1e8) {
                return num.toExponential(2);
            } else {
                return num.toString();
            }
        } else if (dtype === 'object' || dtype === 'string' || dtype === 'category') {
            // å­—ç¬¦ä¸²ç±»å‹
            let str = String(value);
            if (str.length > 5) {
                return '#'.repeat(5);
            } else {
                return str;
            }
        } else {
            // å…¶ä»–ç±»å‹ï¼ˆbool, datetimeç­‰ï¼‰
            return String(value);
        }
    }
    
    // å…¨å±€å˜é‡
    let currentFilename = "";
    let currentMethod = "ols";
    let columnNames = [];
    let lastRawOutput = "";

    // æ–‡ä»¶ä¸Šä¼ ç›‘å¬
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData(); formData.append('file', file);
        
        const statusSpan = document.getElementById('file-status');
        const loader = document.getElementById('upload-loading');
        
        statusSpan.innerText = "æ­£åœ¨ä¸Šä¼ è§£æ...";
        loader.style.display = 'inline-block';
        document.getElementById('fileInput').disabled = true;

        fetch('/upload', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                alert('ä¸Šä¼ é”™è¯¯: ' + d.error);
                statusSpan.innerText = "ä¸Šä¼ å¤±è´¥"; statusSpan.className = "fw-bold text-danger me-2";
            } else {
                currentFilename = d.filename; columnNames = d.columns;
                statusSpan.innerHTML = `<i class="bi bi-check-circle-fill"></i> å½“å‰æ•°æ®: ${d.filename}`;
                statusSpan.className = "fw-bold text-success me-2";
                initUI();
                document.getElementById('setup-panel').style.display = 'block';
                document.getElementById('btn-preview').style.display = 'inline-block';
            }
        })
        .catch(e => alert("ç½‘ç»œé”™è¯¯"))
        .finally(() => { loader.style.display = 'none'; document.getElementById('fileInput').disabled = false; });
    });

    // åˆå§‹åŒ– UI (å¡«å……æ‰€æœ‰ Select å’Œ Checkbox)
    function initUI() {
        const targets = ['y-var-select', 'fe-entity-select', 'fe-time-select', 'cluster-var-select'];
        targets.forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
            columnNames.forEach(col => el.add(new Option(col, col)));
        });
        
        // å¡«å…… Checkbox åˆ—è¡¨
        const fillContainer = (id, cls) => {
            const con = document.getElementById(id);
            con.innerHTML = '';
            columnNames.forEach(col => {
                con.innerHTML += `<div class="form-check"><input class="form-check-input ${cls}" type="checkbox" value="${col}"><label class="small text-truncate">${col}</label></div>`;
            });
        };

        fillContainer('x-var-container', 'x-box');
        fillContainer('c-var-container', 'c-box');
        fillContainer('fe-vars-container', 'fe-box');
        // [æ–°å¢] ç®€å•å˜é‡é€‰æ‹©åˆ—è¡¨
        fillContainer('simple-var-container', 'simple-box');
    }

    // è‡ªåŠ¨å‹¾é€‰å›ºå®šå˜é‡
    document.getElementById('fe-entity-select').addEventListener('change', function(e) {
        if(e.target.value) {
            const chk = document.getElementById(`fe-chk-${e.target.value}`);
            if(chk) chk.checked = true;
        }
    });
    document.getElementById('fe-time-select').addEventListener('change', function(e) {
        if(e.target.value) {
            const chk = document.getElementById(`fe-chk-${e.target.value}`);
            if(chk) chk.checked = true;
        }
    });

    // æŠ˜å é¢æ¿è¾…åŠ©å‡½æ•°
    function togglePanel(forceOpen) {
        const b = document.getElementById('config-body');
        if (forceOpen === true) {
            b.style.display = 'block';
            return;
        }
        b.style.display = (b.style.display === 'none') ? 'block' : 'none';
    }

    // æ ¸å¿ƒï¼šåˆ‡æ¢åˆ†ææ–¹æ³• (æ§åˆ¶ UI æ˜¾éš)
    function selectMethod(m) {
        currentMethod = m;
        document.querySelectorAll('.nav-link-sidebar').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        // 1. æ ‡é¢˜æ›´æ–°
        let titleMap = {
            'ols': 'OLS å›å½’é…ç½®', 'fe': 'å›ºå®šæ•ˆåº”æ¨¡å‹é…ç½®', 'logit': 'Logit æ¨¡å‹é…ç½®', 'probit': 'Probit æ¨¡å‹é…ç½®',
            'desc': 'æè¿°æ€§ç»Ÿè®¡é…ç½®', 'corr': 'ç›¸å…³æ€§åˆ†æé…ç½®', 'vif': 'VIF å…±çº¿æ€§æ£€éªŒ',
            'f_test': 'Fæ£€éªŒé…ç½® (å›ºå®šæ•ˆåº” vs æ··åˆOLS)', 'hausman': 'Hausmanæ£€éªŒé…ç½® (å›ºå®šæ•ˆåº” vs éšæœºæ•ˆåº”)'
        };
        document.getElementById('method-title').innerText = titleMap[m] || m.toUpperCase() + " é…ç½®";

        // 2. åŒºåˆ† å›å½’æ¨¡å¼ vs ç®€å•æ¨¡å¼ vs æ£€éªŒæ¨¡å¼
        const isRegression = ['ols', 'fe', 'logit', 'probit', 'hetero', 'mediation'].includes(m);
        const isTest = ['f_test', 'hausman'].includes(m);
        
        if (isRegression) {
            // æ˜¾ç¤ºå›å½’å˜é‡é€‰æ‹© (Y, X, C)
            document.getElementById('group-vars-regression').classList.remove('d-none-custom');
            document.getElementById('group-vars-simple').classList.add('d-none-custom');
            
            // æ˜¾ç¤ºå›å½’ç»Ÿè®¡é‡é€‰é¡¹
            document.getElementById('stats-group-regression').classList.remove('d-none-custom');
            document.getElementById('stats-group-regression').classList.add('d-flex');
            document.getElementById('stats-group-desc').classList.add('d-none-custom');
            document.getElementById('stats-group-desc').classList.remove('d-flex');

            // æ˜¾ç¤ºæ ‡å‡†è¯¯/è‡ªå®šä¹‰è¡Œ
            document.getElementById('group-se-custom').style.display = 'flex';
            document.getElementById('hr-se-custom').style.display = 'block';
            
            // æ˜¾ç¤ºè¿½åŠ æŒ‰é’®
            document.getElementById('btn-run-append').style.display = 'inline-block';
            document.querySelector('#btn-run-new .btn-text').innerText = "å¼€å§‹æ–°åˆ†æ";
            
            // åªæœ‰å›å½’éœ€è¦æ˜¾ç¤º SE/T åˆ‡æ¢
            document.getElementById('adv-se-toggle').style.visibility = 'visible';

        } else if (isTest) {
            // æ£€éªŒæ¨¡å¼ï¼šæ˜¾ç¤ºå›å½’å˜é‡é€‰æ‹©ä½†ä¸éœ€è¦æ ‡å‡†è¯¯ç­‰
            document.getElementById('group-vars-regression').classList.remove('d-none-custom');
            document.getElementById('group-vars-simple').classList.add('d-none-custom');
            
            // éšè—ç»Ÿè®¡é‡é€‰é¡¹
            document.getElementById('stats-group-regression').classList.add('d-none-custom');
            document.getElementById('stats-group-desc').classList.add('d-none-custom');
            
            // éšè—æ ‡å‡†è¯¯/è‡ªå®šä¹‰è¡Œ
            document.getElementById('group-se-custom').style.display = 'none';
            document.getElementById('hr-se-custom').style.display = 'none';
            
            // éšè—è¿½åŠ æŒ‰é’®
            document.getElementById('btn-run-append').style.display = 'none';
            document.querySelector('#btn-run-new .btn-text').innerText = "æ‰§è¡Œæ£€éªŒ";
            
            // éšè— SE/T åˆ‡æ¢
            document.getElementById('adv-se-toggle').style.visibility = 'hidden';
            
            // å¿…é¡»æ˜¾ç¤ºé¢æ¿è®¾ç½®
            document.getElementById('fe-specific-settings').style.display = 'block';
            
            // Hausmanæ£€éªŒæ˜¾ç¤ºç‰¹å®šè®¾ç½®
            if (m === 'hausman') {
                document.getElementById('hausman-specific-settings').style.display = 'block';
            } else {
                document.getElementById('hausman-specific-settings').style.display = 'none';
            }

        } else {
            // ç®€å•æ¨¡å¼ (Desc, Corr, VIF)
            // æ˜¾ç¤ºç®€å•å˜é‡é€‰æ‹©
            document.getElementById('group-vars-regression').classList.add('d-none-custom');
            document.getElementById('group-vars-simple').classList.remove('d-none-custom');
            
            // éšè—æ ‡å‡†è¯¯/è‡ªå®šä¹‰è¡Œ
            document.getElementById('group-se-custom').style.display = 'none';
            document.getElementById('hr-se-custom').style.display = 'none';
            
            // éšè—è¿½åŠ æŒ‰é’®
            document.getElementById('btn-run-append').style.display = 'none';
            document.querySelector('#btn-run-new .btn-text').innerText = "ç”ŸæˆæŠ¥å‘Š";
            
            // éšè— SE/T åˆ‡æ¢ (å ä½ä½†ä¸å¯è§ï¼Œä¿æŒå¸ƒå±€)
            document.getElementById('adv-se-toggle').style.visibility = 'hidden';

            // ç»Ÿè®¡é‡é€‰é¡¹åˆ‡æ¢
            if (m === 'desc') {
                document.getElementById('stats-group-regression').classList.add('d-none-custom');
                document.getElementById('stats-group-regression').classList.remove('d-flex');
                document.getElementById('stats-group-desc').classList.remove('d-none-custom');
                document.getElementById('stats-group-desc').classList.add('d-flex');
            } else {
                // Corr/VIF ä¸éœ€è¦é€‰ç»Ÿè®¡é‡
                document.getElementById('stats-group-regression').classList.add('d-none-custom');
                document.getElementById('stats-group-desc').classList.add('d-none-custom');
            }
            
            // éšè—é¢æ¿è®¾ç½®
            document.getElementById('fe-specific-settings').style.display = 'none';
        }

        // FE ç‰¹æœ‰è®¾ç½®ï¼ˆåªåœ¨FEæ¨¡å¼æ˜¾ç¤ºï¼Œæ£€éªŒæ¨¡å¼å·²ç»åœ¨ä¸Šé¢å¤„ç†ï¼‰
        if (m === 'fe') {
            document.getElementById('fe-specific-settings').style.display = 'block';
        }
        
        togglePanel(true);
    }
    
    function toggleClusterVar() {
        const type = document.getElementById('se-type-select').value;
        document.getElementById('cluster-var-box').style.display = (type === 'cluster') ? 'block' : 'none';
    }

    // è¿è¡Œåˆ†æ
    function runAnalysis(actionType) {
        const btnId = actionType === 'new' ? 'btn-run-new' : 'btn-run-append';
        const btn = document.getElementById(btnId);
        const spinner = btn.querySelector('.spinner-border');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡å‹æ£€éªŒ
        if (currentMethod === 'f_test' || currentMethod === 'hausman') {
            runModelTest(currentMethod, btn, spinner);
            return;
        }
        
        // 1. æ”¶é›†é€šç”¨å‚æ•°
        const decimals = document.getElementById('decimal-input').value; // ä¿ç•™å°æ•°ä½è®¾ç½®
        const showSe = document.getElementById('show_se').checked;
        const tableTitle = document.getElementById('default-title').value;
        
        let payload = {
            action: actionType, filename: currentFilename, method: currentMethod,
            decimals: decimals, show_se: showSe, table_title: tableTitle,
            se_type: document.getElementById('se-type-select').value,
            cluster_var: document.getElementById('cluster-var-select').value,
            panel_entity: document.getElementById('fe-entity-select').value,
            panel_time: document.getElementById('fe-time-select').value,
            fe_vars: Array.from(document.querySelectorAll('.fe-box:checked')).map(e=>e.value),
            custom_rows: Array.from(document.querySelectorAll('.custom-row-item')).map(row => ({
                label: row.children[0].value, value: row.children[1].value
            }))
        };

        // 2. æ”¶é›†å˜é‡ (æ ¹æ®æ¨¡å¼)
        const isRegression = ['ols', 'fe', 'logit', 'probit', 'hetero', 'mediation'].includes(currentMethod);
        
        if (isRegression) {
            payload.y_var = document.getElementById('y-var-select').value;
            const xVars = Array.from(document.querySelectorAll('.x-box:checked')).map(e=>e.value);
            const cVars = Array.from(document.querySelectorAll('.c-box:checked')).map(e=>e.value);
            const manual = document.getElementById('manual-controls').value;
            payload.x_vars = xVars.concat(cVars);
            payload.manual_controls = manual;
            
            // æ”¶é›†å›å½’ç»Ÿè®¡é‡
            let opts = ['nobs'];
            document.querySelectorAll('.export-opt:checked').forEach(cb => { if(cb.value !== 'nobs') opts.push(cb.value); });
            payload.export_options = opts;

            // æ ¡éªŒ
            if (!payload.y_var) { alert("è¯·é€‰æ‹©å› å˜é‡ Y"); return; }
            if (currentMethod === 'fe') {
                if (!payload.panel_entity || !payload.panel_time) { alert("å›ºå®šæ•ˆåº”æ¨¡å‹å¿…é¡»è®¾ç½® Entity å’Œ Time ID"); return; }
                if (payload.fe_vars.length === 0) { alert("è¯·å‹¾é€‰è‡³å°‘ä¸€ä¸ªå›ºå®šæ•ˆåº”å˜é‡ (å¦‚ Year æˆ– Industry)"); return; }
            }

        } else {
            // ç®€å•æ¨¡å¼ï¼šæ”¶é›† simple-box
            payload.x_vars = Array.from(document.querySelectorAll('.simple-box:checked')).map(e=>e.value);
            
            // æ”¶é›†æè¿°ç»Ÿè®¡é‡
            if (currentMethod === 'desc') {
                let opts = [];
                document.querySelectorAll('.desc-opt:checked').forEach(cb => opts.push(cb.value));
                payload.export_options = opts;
            }
            
            if (payload.x_vars.length === 0) { alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå˜é‡"); return; }
        }

        btn.disabled = true; spinner.classList.remove('d-none');

        fetch('/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            if(data.error) {
                 if(data.error.includes("unit interval")) alert("Logit/Probit é”™è¯¯: Yå¿…é¡»ä¸º0/1");
                 else alert(data.error);
            } else {
                document.getElementById('table-output').innerHTML = data.html_table;
                lastRawOutput = data.raw_output;
                document.getElementById('result-container').style.display = 'block';
                if(actionType === 'new') togglePanel(false);
                
                // æ§åˆ¶â€œæŸ¥çœ‹åŸå§‹è¾“å‡ºâ€æŒ‰é’®æ˜¾éš
                document.getElementById('btn-show-raw').style.display = isRegression ? 'inline-block' : 'none';
            }
        })
        .catch(e => alert("æœåŠ¡å™¨é”™è¯¯: " + e))
        .finally(() => {
            btn.disabled = false; spinner.classList.add('d-none');
        });
    }

    function addCustomRow() {
        const div = document.createElement('div');
        div.className = 'custom-row-item';
        div.innerHTML = `
            <input type="text" class="form-control form-control-sm" placeholder="Label" style="width: 60%">
            <input type="text" class="form-control form-control-sm" placeholder="Value" style="width: 30%">
            <button class="btn btn-sm btn-danger px-2" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('custom-rows-container').appendChild(div);
    }
    
    function showRaw() { 
        document.getElementById('raw-text').innerText = lastRawOutput; 
        new bootstrap.Modal(document.getElementById('rawModal')).show(); 
    }

    // é¢„è§ˆæ•°æ® (å®Œå…¨ä¿ç•™)
    function previewData() {
        if (!currentFilename) { alert('æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶'); return; }
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        const modalBody = document.querySelector('#previewModal .modal-body');
        modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p>åŠ è½½ä¸­...</p></div>';
        modal.show();
        
        fetch(`/preview?filename=${encodeURIComponent(currentFilename)}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) { modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`; return; }
                let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
                data.columns.forEach(col => { html += `<th title="ç±»å‹: ${data.dtypes[col]}">${escapeHtml(col)}</th>`; });
                html += '</tr></thead><tbody>';
                data.preview.forEach(row => {
                    html += '<tr>';
                    data.columns.forEach(col => {
                        let val = row[col];
                        let rawAttr = `data-raw="${encodeURIComponent(JSON.stringify(val))}" data-dtype="${data.dtypes[col]}"`;
                        html += `<td ${rawAttr}>${escapeHtml(formatCell(val, data.dtypes[col]))}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
                
                modalBody.addEventListener('dblclick', function(e) {
                    const td = e.target.closest('td');
                    if (!td) return;
                    const raw = decodeURIComponent(td.getAttribute('data-raw'));
                    let original; try { original = JSON.parse(raw); } catch { original = raw; }
                    const currentText = td.textContent;
                    const originalText = (original === null || original === undefined) ? '' : String(original);
                    if (currentText === originalText) {
                        td.textContent = formatCell(original, td.getAttribute('data-dtype'));
                    } else {
                        td.textContent = originalText;
                    }
                });
            })
            .catch(err => modalBody.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥: ${err}</div>`);
    }

    // è¿è¡Œæ¨¡å‹æ£€éªŒï¼ˆFæ£€éªŒæˆ–Hausmanæ£€éªŒï¼‰
    function runModelTest(testType, btn, spinner) {
        // æ”¶é›†å‚æ•°
        const y_var = document.getElementById('y-var-select').value;
        const xVars = Array.from(document.querySelectorAll('.x-box:checked')).map(e=>e.value);
        const cVars = Array.from(document.querySelectorAll('.c-box:checked')).map(e=>e.value);
        const manual = document.getElementById('manual-controls').value;
        const panel_entity = document.getElementById('fe-entity-select').value;
        const panel_time = document.getElementById('fe-time-select').value;
        const decimals = document.getElementById('decimal-input').value;
        
        // å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„æ§åˆ¶å˜é‡
        let allXVars = xVars.concat(cVars);
        if (manual) {
            const manualVars = manual.split(/[\s,]+/).filter(v => v.trim() !== '');
            allXVars = allXVars.concat(manualVars);
        }
        
        // æ ¡éªŒ
        if (!y_var) { alert("è¯·é€‰æ‹©å› å˜é‡ Y"); return; }
        if (allXVars.length === 0) { alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè‡ªå˜é‡æˆ–æ§åˆ¶å˜é‡"); return; }
        if (!panel_entity || !panel_time) { alert("æ¨¡å‹æ£€éªŒå¿…é¡»è®¾ç½® Entity å’Œ Time ID"); return; }
        
        const payload = {
            filename: currentFilename,
            y_var: y_var,
            x_vars: allXVars,
            panel_entity: panel_entity,
            panel_time: panel_time,
            decimals: decimals
        };
        
        // Hausmanæ£€éªŒç‰¹æœ‰å‚æ•°ï¼šsigmamoreé€‰é¡¹
        if (testType === 'hausman') {
            payload.sigmamore = document.getElementById('sigmamore-checkbox').checked;
        }
        
        btn.disabled = true; spinner.classList.remove('d-none');
        
        const endpoint = testType === 'f_test' ? '/f_test' : '/hausman_test';
        
        fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            if(data.error) {
                alert("æ£€éªŒé”™è¯¯: " + data.error);
            } else {
                displayTestResult(data.result, testType);
                document.getElementById('result-container').style.display = 'block';
                togglePanel(false);
                document.getElementById('btn-show-raw').style.display = 'none';
            }
        })
        .catch(e => alert("æœåŠ¡å™¨é”™è¯¯: " + e))
        .finally(() => {
            btn.disabled = false; spinner.classList.add('d-none');
        });
    }

    // æ˜¾ç¤ºæ£€éªŒç»“æœ
    function displayTestResult(result, testType) {
        let html = '<div class="card shadow-sm"><div class="card-body">';
        
        if (result.error) {
            html += `<div class="alert alert-warning"><strong>æ³¨æ„ï¼š</strong>${result.error}</div>`;
            html += `<p class="text-muted">${result.suggestion || ''}</p>`;
            
            // å³ä½¿æœ‰é”™è¯¯ï¼Œä¹Ÿæ˜¾ç¤ºç³»æ•°å¯¹æ¯”
            if (result.fe_coeffs && result.re_coeffs) {
                html += '<h6 class="mt-3">ç³»æ•°å¯¹æ¯”ï¼š</h6>';
                html += '<div class="table-responsive">';
                html += '<table class="table table-sm table-bordered">';
                html += '<thead class="table-light"><tr><th>å˜é‡</th><th>å›ºå®šæ•ˆåº” (b)</th><th>éšæœºæ•ˆåº” (B)</th><th>å·®å¼‚ (b-B)</th>';
                if (result.fe_std_err) html += '<th>FEæ ‡å‡†è¯¯</th><th>REæ ‡å‡†è¯¯</th>';
                html += '</tr></thead><tbody>';
                for (let key in result.fe_coeffs) {
                    html += `<tr><td>${key}</td><td>${result.fe_coeffs[key]}</td><td>${result.re_coeffs[key]}</td>`;
                    html += `<td>${result.coeff_diff ? result.coeff_diff[key] : '-'}</td>`;
                    if (result.fe_std_err) {
                        html += `<td>${result.fe_std_err[key]}</td><td>${result.re_std_err[key]}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
        } else {
            html += `<h5 class="text-primary mb-3">${result.test_name}</h5>`;
            
            // å‡è®¾æ£€éªŒ
            html += '<div class="row mb-3">';
            html += '<div class="col-md-6">';
            html += `<p><strong>åŸå‡è®¾ (Hâ‚€)ï¼š</strong><br>${result.null_hypothesis}</p>`;
            html += '</div>';
            html += '<div class="col-md-6">';
            html += `<p><strong>å¤‡æ‹©å‡è®¾ (Hâ‚)ï¼š</strong><br>${result.alternative_hypothesis}</p>`;
            html += '</div>';
            html += '</div>';
            
            // æ£€éªŒç»Ÿè®¡é‡
            html += '<div class="table-responsive mb-3">';
            html += '<table class="table table-bordered table-sm">';
            html += '<thead class="table-light"><tr><th>ç»Ÿè®¡é‡</th><th>å€¼</th></tr></thead>';
            html += '<tbody>';
            
            if (testType === 'f_test') {
                html += `<tr><td>Fç»Ÿè®¡é‡</td><td>${result.f_statistic}${result.significance}</td></tr>`;
                html += `<tr><td>è‡ªç”±åº¦ (df1, df2)</td><td>(${result.df1}, ${result.df2})</td></tr>`;
                html += `<tr><td>På€¼</td><td>${result.p_value}</td></tr>`;
                html += `<tr><td>RSS (Pooled OLS)</td><td>${result.rss_pooled}</td></tr>`;
                html += `<tr><td>RSS (Fixed Effects)</td><td>${result.rss_fe}</td></tr>`;
                html += `<tr><td>ä¸ªä½“æ•°é‡</td><td>${result.n_entities}</td></tr>`;
                html += `<tr><td>è§‚æµ‹æ•°é‡</td><td>${result.n_obs}</td></tr>`;
            } else {
                html += `<tr><td>å¡æ–¹ç»Ÿè®¡é‡ (Ï‡Â²)</td><td>${result.chi2_statistic}${result.significance}</td></tr>`;
                html += `<tr><td>è‡ªç”±åº¦ (df)</td><td>${result.df}</td></tr>`;
                html += `<tr><td>På€¼</td><td>${result.p_value}</td></tr>`;
            }
            
            html += '</tbody></table></div>';
            
            // ç»“è®º
            html += `<div class="alert alert-${result.p_value < 0.05 ? 'success' : 'info'}">`;
            html += `<strong>ç»“è®ºï¼š</strong>${result.conclusion}`;
            html += '</div>';
            
            // æ˜¾è‘—æ€§è¯´æ˜
            html += '<p class="text-muted small">*** p<0.01, ** p<0.05, * p<0.1</p>';
            
            // Hausmanæ£€éªŒæ˜¾ç¤ºè¯¦ç»†ç³»æ•°å¯¹æ¯”
            if (testType === 'hausman' && result.fe_coeffs && result.re_coeffs) {
                html += '<h6 class="mt-3">ç³»æ•°å¯¹æ¯”ï¼ˆCoefficientsï¼‰ï¼š</h6>';
                html += '<div class="table-responsive">';
                html += '<table class="table table-sm table-bordered">';
                html += '<thead class="table-light"><tr><th>å˜é‡</th><th>å›ºå®šæ•ˆåº” (b)</th><th>éšæœºæ•ˆåº” (B)</th><th>å·®å¼‚ (b-B)</th>';
                if (result.fe_std_err) html += '<th>FEæ ‡å‡†è¯¯</th><th>REæ ‡å‡†è¯¯</th>';
                if (result.std_err_diff) html += '<th>å·®å¼‚æ ‡å‡†è¯¯ sqrt(V_b-V_B)</th>';
                html += '</tr></thead><tbody>';
                for (let key in result.fe_coeffs) {
                    html += `<tr><td>${key}</td><td>${result.fe_coeffs[key]}</td><td>${result.re_coeffs[key]}</td>`;
                    html += `<td>${result.coeff_diff ? result.coeff_diff[key] : '-'}</td>`;
                    if (result.fe_std_err) {
                        html += `<td>${result.fe_std_err[key]}</td><td>${result.re_std_err[key]}</td>`;
                    }
                    if (result.std_err_diff) {
                        html += `<td>${result.std_err_diff[key]}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
                html += '<p class="text-muted small mt-2">b = Consistent under H0 and Ha (å›ºå®šæ•ˆåº”ä¼°è®¡)<br>';
                html += 'B = Inconsistent under Ha, efficient under H0 (éšæœºæ•ˆåº”ä¼°è®¡)</p>';
            }
        }
        
        html += '</div></div>';
        document.getElementById('table-output').innerHTML = html;
    }
</script>
{% endblock %}
