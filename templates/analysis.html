{% extends "base.html" %}

{% block title %}æ•°æ®åˆ†æ{% endblock %}

{% block styles %}
<style>
    /* åˆ†æé¡µé¢å…¨å±€å¸ƒå±€ */
    .analysis-container { display: flex !important; flex-direction: row !important; height: calc(100vh - 56px); width: 100%; overflow: hidden; }
    
    /* å·¦ä¾§å¯¼èˆªæ  */
    #sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #1a252f; }
    .nav-link-sidebar { color: #bdc3c7; cursor: pointer; padding: 12px 20px; display: block; text-decoration: none; transition: 0.2s;}
    .nav-link-sidebar:hover, .nav-link-sidebar.active { color: white; background-color: #34495e; border-left: 4px solid #1abc9c; }
    .sidebar-header { font-size: 0.85rem; font-weight: bold; color: #6c757d; padding: 10px 20px 5px 20px; text-transform: uppercase; letter-spacing: 1px; }

    /* å³ä¾§å†…å®¹åŒº */
    .content-area { flex: 1; padding: 20px; height: 100%; overflow-y: auto; background-color: #f4f6f9; position: relative; }
    
    /* å˜é‡åˆ—è¡¨å®¹å™¨ */
    .var-list-container { border: 1px solid #ced4da; height: 160px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px; }
    
    /* è¡¨æ ¼æ ·å¼ */
    .table-editable-container { text-align: center; margin-top: 20px; overflow-x: auto; }
    .table-title-input { border: none; background: transparent; font-size: 1.2em; font-weight: bold; text-align: center; width: 80%; border-bottom: 1px dashed #ccc; }
    .table-title-input:focus { outline: none; border-bottom: 1px solid #000; }
    
    /* å­¦æœ¯è¡¨æ ¼åŸºç¡€æ ·å¼ */
    .academic-table { border-collapse: collapse; margin: 0 auto; font-family: "Times New Roman", serif; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-width: 50%; }
    .academic-table td, .academic-table th { padding: 6px 12px; white-space: nowrap; }
    
    /* Loading æ ·å¼ */
    .spinner-border-sm { width: 1rem; height: 1rem; border-width: 0.15em; }

    /* æ¨¡å—æ˜¾éšæ§åˆ¶ */
    .analysis-module { display: none; }
    .analysis-module.active { display: block; }

    /* é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
    #previewModal .modal-body { max-height: 70vh; overflow-y: auto; }
    #previewModal .table td, #previewModal .table th { white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <div id="sidebar">
        <!-- åŸºç¡€åˆ†æåŒº -->
        <div class="sidebar-header">åŸºç¡€åˆ†æ</div>
        <a class="nav-link-sidebar" data-module="descriptive" onclick="switchModule('descriptive')">ğŸ“Š æè¿°æ€§ç»Ÿè®¡</a>
        <a class="nav-link-sidebar" data-module="grouped-descriptive" onclick="switchModule('grouped-descriptive')">ğŸ“Š åˆ†ç»„æè¿°æ€§ç»Ÿè®¡</a>
        <a class="nav-link-sidebar" data-module="frequency" onclick="switchModule('frequency')">ğŸ“‹ é¢‘æ•°ç»Ÿè®¡</a>
        <a class="nav-link-sidebar" data-module="correlation" onclick="switchModule('correlation')">ğŸ”— ç›¸å…³æ€§åˆ†æ</a>
        <a class="nav-link-sidebar" data-module="vif" onclick="switchModule('vif')">âš ï¸ VIF å…±çº¿æ€§æ£€éªŒ</a>

        <hr style="border-color: #4b5d6b; margin: 10px 0;">

        <!-- å›å½’æ¨¡å‹åŒº -->
        <div class="sidebar-header">å›å½’æ¨¡å‹</div>
        <a class="nav-link-sidebar active" data-module="regression" data-method="ols" onclick="switchModule('regression', 'ols')">ğŸ“ˆ çº¿æ€§ OLS å›å½’</a>
        <a class="nav-link-sidebar" data-module="regression" data-method="fe" onclick="switchModule('regression', 'fe')">ğŸ—ï¸ å›ºå®šæ•ˆåº”æ¨¡å‹</a>
        <a class="nav-link-sidebar" data-module="regression" data-method="re" onclick="switchModule('regression', 're')">ğŸ”€ éšæœºæ•ˆåº”æ¨¡å‹</a>
        <a class="nav-link-sidebar" data-module="regression" data-method="pooled" onclick="switchModule('regression', 'pooled')">ğŸ“Š æ··åˆæ•ˆåº”æ¨¡å‹</a>
        <a class="nav-link-sidebar" data-module="regression" data-method="logit" onclick="switchModule('regression', 'logit')">ğŸŸ¢ Logit æ¨¡å‹</a>
        <a class="nav-link-sidebar" data-module="regression" data-method="probit" onclick="switchModule('regression', 'probit')">ğŸ”µ Probit æ¨¡å‹</a>

        <hr style="border-color: #4b5d6b; margin: 10px 0;">

        <!-- æ¨¡å‹æ£€éªŒåŒº -->
        <div class="sidebar-header">æ¨¡å‹æ£€éªŒ</div>
        <a class="nav-link-sidebar" data-module="test" data-method="f_test" onclick="switchModule('test', 'f_test')">ğŸ”¬ Fæ£€éªŒ (FE vs Pooled)</a>
        <a class="nav-link-sidebar" data-module="test" data-method="hausman" onclick="switchModule('test', 'hausman')">ğŸ§ª Hausmanæ£€éªŒ (FE vs RE)</a>
    </div>

    <!-- å³ä¾§å†…å®¹ -->
    <div class="content-area">
        {% if not current_user.is_authenticated %}
        <div class="alert alert-warning text-center py-2 mb-3"><small>âš ï¸ æ¸¸å®¢æ¨¡å¼ä¸‹æ— æ³•ä¿å­˜å†å²è®°å½•ã€‚</small></div>
        {% endif %}

        <!-- æ–‡ä»¶ä¸Šä¼  -->
        <div class="card mb-3 shadow-sm border-warning" id="upload-card">
            <div class="card-body py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span id="file-status" class="fw-bold text-warning me-2" style="font-size: 1.1rem;">
                        <i class="bi bi-exclamation-triangle-fill"></i> è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶
                    </span>
                    <div id="upload-loading" class="spinner-border spinner-border-sm text-primary" style="display:none;"></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button id="btn-preview" class="btn btn-sm btn-outline-primary" style="display:none;" onclick="previewData()">é¢„è§ˆæ•°æ®</button>
                    <input type="file" id="fileInput" class="form-control form-control-sm" style="width: auto;" accept=".csv, .xlsx, .dta">
                </div>
            </div>
        </div>

        <!-- æ¨¡å—å®¹å™¨ -->
        <div id="modules-container">
            <!-- å„ä¸ªæ¨¡å—å°†é€šè¿‡includeåŠ è½½ -->
            {% include 'analysis_modules/descriptive.html' %}
            {% include 'analysis_modules/grouped_descriptive.html' %}
            {% include 'analysis_modules/frequency.html' %}
            {% include 'analysis_modules/correlation.html' %}
            {% include 'analysis_modules/vif.html' %}
            {% include 'analysis_modules/regression.html' %}
            {% include 'analysis_modules/model_test.html' %}
        </div>
    </div>
</div>

<!-- æ•°æ®é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ•°æ®é¢„è§ˆ (å‰10è¡Œ)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // å…¨å±€å˜é‡
    window.currentFilename = "";
    let columnNames = [];
    let currentActiveModule = "regression";

    // HTMLè½¬ä¹‰è¾…åŠ©å‡½æ•°
    function escapeHtml(str) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '/': '&#x2F;' };
        return String(str).replace(/[&<>"'/]/g, (c) => map[c]);
    }

    // å•å…ƒæ ¼æ ¼å¼åŒ–å‡½æ•°
    function formatCell(value, dtype) {
        if (value === null || value === undefined) return '';
        if (dtype.startsWith('float')) {
            let num = Number(value);
            if (isNaN(num)) return String(value);
            if (Math.abs(num) >= 1e6 || (Math.abs(num) <= 1e-4 && num !== 0)) {
                return num.toExponential(2);
            } else {
                return num.toFixed(2);
            }
        } else if (dtype.startsWith('int') || dtype.startsWith('uint')) {
            let num = Number(value);
            if (isNaN(num)) return String(value);
            if (Math.abs(num) >= 1e8) {
                return num.toExponential(2);
            } else {
                return num.toString();
            }
        } else if (dtype === 'object' || dtype === 'string' || dtype === 'category') {
            let str = String(value);
            if (str.length > 5) {
                return '#'.repeat(5);
            } else {
                return str;
            }
        } else {
            return String(value);
        }
    }

    // æ–‡ä»¶ä¸Šä¼ ç›‘å¬
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        
        const statusSpan = document.getElementById('file-status');
        const loader = document.getElementById('upload-loading');
        
        statusSpan.innerText = "æ­£åœ¨ä¸Šä¼ è§£æ...";
        loader.style.display = 'inline-block';
        document.getElementById('fileInput').disabled = true;

        fetch('/upload', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                alert('ä¸Šä¼ é”™è¯¯: ' + d.error);
                statusSpan.innerText = "ä¸Šä¼ å¤±è´¥";
                statusSpan.className = "fw-bold text-danger me-2";
            } else {
                window.currentFilename = d.filename;
                columnNames = d.columns;
                statusSpan.innerHTML = `<i class="bi bi-check-circle-fill"></i> å½“å‰æ•°æ®: ${d.filename}`;
                statusSpan.className = "fw-bold text-success me-2";
                
                // ä¿®æ”¹å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºç»¿è‰²
                document.getElementById('upload-card').className = "card mb-3 shadow-sm border-success";
                
                // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
                initAllModules(columnNames);
                
                // æ˜¾ç¤ºå½“å‰æ¿€æ´»çš„æ¨¡å—å¹¶å±•å¼€é…ç½®é¢æ¿
                showCurrentModule();
                
                // å±•å¼€å½“å‰æ¨¡å—çš„é…ç½®é¢æ¿
                expandCurrentModulePanel();
                
                document.getElementById('btn-preview').style.display = 'inline-block';
            }
        })
        .catch(e => alert("ç½‘ç»œé”™è¯¯"))
        .finally(() => {
            loader.style.display = 'none';
            document.getElementById('fileInput').disabled = false;
        });
    });

    // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
    function initAllModules(columns) {
        if (typeof initDescriptiveModule === 'function') initDescriptiveModule(columns);
        if (typeof initGroupedDescriptiveModule === 'function') initGroupedDescriptiveModule(columns);
        if (typeof initFrequencyModule === 'function') initFrequencyModule(columns);
        if (typeof initCorrelationModule === 'function') initCorrelationModule(columns);
        if (typeof initVIFModule === 'function') initVIFModule(columns);
        if (typeof initRegressionModule === 'function') initRegressionModule(columns);
        if (typeof initTestModule === 'function') initTestModule(columns);
    }

    // åˆ‡æ¢æ¨¡å—
    function switchModule(moduleName, method) {
        // æ›´æ–°å¯¼èˆªæ æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.nav-link-sidebar').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        // éšè—æ‰€æœ‰æ¨¡å—
        document.querySelectorAll('.analysis-module').forEach(el => {
            el.classList.remove('active');
        });
        
        // æ˜¾ç¤ºç›®æ ‡æ¨¡å—
        const targetModule = document.getElementById(`module-${moduleName}`);
        if (targetModule) {
            targetModule.classList.add('active');
            currentActiveModule = moduleName;
            
            // å¦‚æœæ˜¯å›å½’æˆ–æ£€éªŒæ¨¡å—ï¼Œè®¾ç½®å…·ä½“æ–¹æ³•
            if (moduleName === 'regression' && method && typeof setRegressionMethod === 'function') {
                setRegressionMethod(method);
            } else if (moduleName === 'test' && method && typeof setTestMethod === 'function') {
                setTestMethod(method);
            }
            
            // å¦‚æœå·²ä¸Šä¼ æ•°æ®ï¼Œè‡ªåŠ¨å±•å¼€é…ç½®é¢æ¿
            if (window.currentFilename) {
                const panelId = `${moduleName}-config-body`;
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'block';
                }
            }
        }
    }

    // æ˜¾ç¤ºå½“å‰æ¿€æ´»çš„æ¨¡å—
    function showCurrentModule() {
        const targetModule = document.getElementById(`module-${currentActiveModule}`);
        if (targetModule) {
            targetModule.classList.add('active');
            
            // é»˜è®¤æ˜¾ç¤ºOLSå›å½’
            if (currentActiveModule === 'regression' && typeof setRegressionMethod === 'function') {
                setRegressionMethod('ols');
            }
        }
    }
    
    // å±•å¼€å½“å‰æ¨¡å—çš„é…ç½®é¢æ¿
    function expandCurrentModulePanel() {
        const panelId = `${currentActiveModule}-config-body`;
        const panel = document.getElementById(panelId);
        if (panel) {
            panel.style.display = 'block';
        }
    }

    // æ•°æ®é¢„è§ˆ
    function previewData() {
        if (!window.currentFilename) {
            alert('æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶');
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        const modalBody = document.querySelector('#previewModal .modal-body');
        modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p>åŠ è½½ä¸­...</p></div>';
        modal.show();
        
        fetch(`/preview?filename=${encodeURIComponent(window.currentFilename)}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
                data.columns.forEach(col => {
                    html += `<th title="ç±»å‹: ${data.dtypes[col]}">${escapeHtml(col)}</th>`;
                });
                html += '</tr></thead><tbody>';
                data.preview.forEach(row => {
                    html += '<tr>';
                    data.columns.forEach(col => {
                        let val = row[col];
                        let rawAttr = `data-raw="${encodeURIComponent(JSON.stringify(val))}" data-dtype="${data.dtypes[col]}"`;
                        html += `<td ${rawAttr}>${escapeHtml(formatCell(val, data.dtypes[col]))}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
                
                // åŒå‡»åˆ‡æ¢æ˜¾ç¤ºåŸå§‹å€¼
                modalBody.addEventListener('dblclick', function(e) {
                    const td = e.target.closest('td');
                    if (!td) return;
                    const raw = decodeURIComponent(td.getAttribute('data-raw'));
                    let original;
                    try {
                        original = JSON.parse(raw);
                    } catch {
                        original = raw;
                    }
                    const currentText = td.textContent;
                    const originalText = (original === null || original === undefined) ? '' : String(original);
                    if (currentText === originalText) {
                        td.textContent = formatCell(original, td.getAttribute('data-dtype'));
                    } else {
                        td.textContent = originalText;
                    }
                });
            })
            .catch(err => modalBody.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥: ${err}</div>`);
    }

    // é¡µé¢åŠ è½½æ—¶é»˜è®¤æ˜¾ç¤ºå›å½’æ¨¡å—ï¼ˆä½†ä¸å±•å¼€é…ç½®é¢æ¿ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
        showCurrentModule();
        // æœªä¸Šä¼ æ•°æ®æ—¶ï¼Œé»˜è®¤æŠ˜å æ‰€æœ‰é…ç½®é¢æ¿
        collapseAllModulePanels();
    });
    
    // æŠ˜å æ‰€æœ‰æ¨¡å—çš„é…ç½®é¢æ¿
    function collapseAllModulePanels() {
        const panelIds = [
            'descriptive-config-body',
            'grouped-descriptive-config-body',
            'frequency-config-body',
            'correlation-config-body',
            'vif-config-body',
            'regression-config-body',
            'test-config-body'
        ];
        panelIds.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) {
                panel.style.display = 'none';
            }
        });
    }
</script>

<!-- å¯¼å‡ºåŠŸèƒ½ä¾èµ–åº“ -->
<script src="{{ url_for('static', filename='js/FileSaver.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/html-docx.js') }}"></script>
<script src="{{ url_for('static', filename='js/xlsx.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
{% endblock %}
