{% extends "base.html" %}

{% block title %}数据分析{% endblock %}

{% block styles %}
<style>
    /* 分析页面全局布局 */
    .analysis-container { display: flex !important; flex-direction: row !important; height: calc(100vh - 56px); width: 100%; overflow: hidden; }

    /* 左侧导航栏 */
    #sidebar {
        width: 250px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding-top: 20px;
        overflow-y: auto;
        flex-shrink: 0;
        border-right: 1px solid var(--border-color);
    }

    .nav-link-sidebar {
        color: var(--text-secondary);
        cursor: pointer;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 2px solid transparent;
    }

    .nav-link-sidebar:hover {
        color: var(--accent-primary);
        background: var(--bg-tertiary);
        border-left-color: var(--accent-primary);
    }

    .nav-link-sidebar.active {
        color: var(--accent-primary);
        background: var(--bg-elevated);
        border-left-color: var(--accent-primary);
        box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
    }

    .sidebar-header {
        font-size: 0.625rem;
        font-weight: 700;
        color: var(--text-muted);
        padding: 10px 20px 5px 20px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    /* 右侧内容区 */
    .content-area {
        flex: 1;
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        background: var(--gradient-surface);
        position: relative;
    }

    /* 隐藏右侧内容区滚动条 */
    .content-area::-webkit-scrollbar {
        width: 0px;
    }

    /* 变量列表容器 */
    .var-list-container {
        border: 1px solid var(--border-color);
        height: 160px;
        overflow-y: auto;
        background: var(--bg-tertiary);
        padding: 10px;
        border-radius: var(--radius-md);
    }

    /* 表格样式 */
    .table-editable-container { text-align: center; margin-top: 20px; overflow-x: auto; }
    .table-title-input {
        border: none;
        background: transparent;
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        width: 80%;
        border-bottom: 1px dashed var(--border-color);
        color: var(--text-primary);
    }
    .table-title-input:focus { outline: none; border-bottom: 1px solid var(--accent-primary); }

    /* 学术表格基础样式 */
    .academic-table { border-collapse: collapse; margin: 0 auto; font-family: "Times New Roman", serif; background: var(--bg-secondary); box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 50%; }
    .academic-table td, .academic-table th { padding: 6px 12px; white-space: nowrap; }

    /* Loading 样式 */
    .spinner-border-sm { width: 1rem; height: 1rem; border-width: 0.15em; }

    /* 模块显隐控制 */
    .analysis-module { display: none; }
    .analysis-module.active { display: block; }

    /* 预览模态框样式 */
    #previewModal .modal-body { max-height: 70vh; overflow-y: auto; }
    #previewModal .table td, #previewModal .table th { white-space: nowrap; }

    /* ========== 暗色主题覆盖 ========== */
    /* 卡片 */
    .card {
        background: var(--bg-secondary) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
    }

    .card-header {
        background: var(--bg-tertiary) !important;
        border-bottom: 1px solid var(--border-accent) !important;
        color: var(--text-primary) !important;
    }

    .card-body {
        background: var(--bg-secondary) !important;
    }

    /* 表单控件 */
    .form-control, .form-select {
        background: var(--bg-tertiary) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .form-control:focus, .form-select:focus {
        background: var(--bg-tertiary) !important;
        border-color: var(--accent-primary) !important;
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1) !important;
        color: var(--text-primary) !important;
    }

    .form-control::placeholder {
        color: var(--text-muted) !important;
    }

    .form-check-input {
        background-color: var(--bg-tertiary) !important;
        border-color: var(--border-color) !important;
    }

    .form-check-input:checked {
        background-color: var(--accent-primary) !important;
        border-color: var(--accent-primary) !important;
    }

    .form-check-label {
        color: var(--text-secondary) !important;
    }

    /* 标签 */
    label, .small {
        color: var(--text-secondary) !important;
    }

    /* 按钮 */
    .btn-light {
        background: var(--bg-tertiary) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-secondary) !important;
    }

    .btn-light:hover {
        background: var(--bg-elevated) !important;
        border-color: var(--accent-primary) !important;
        color: var(--accent-primary) !important;
    }

    /* 模态框 */
    .modal-content {
        background: var(--bg-secondary) !important;
        border: 1px solid var(--border-color) !important;
    }

    .modal-header {
        background: var(--bg-tertiary) !important;
        border-bottom: 1px solid var(--border-accent) !important;
    }

    .modal-body {
        background: var(--bg-secondary) !important;
    }

    .modal-footer {
        background: var(--bg-tertiary) !important;
        border-top: 1px solid var(--border-accent) !important;
    }

    .modal-title {
        color: var(--text-primary) !important;
    }

    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    /* 表格 */
    .table {
        color: var(--text-secondary) !important;
    }

    .table thead th {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
    }

    .table tbody td {
        border-color: var(--border-color) !important;
    }

    .table-hover tbody tr:hover {
        background: var(--bg-tertiary) !important;
    }

    /* Alert */
    .alert {
        background: var(--bg-tertiary) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .alert-warning {
        border-color: var(--accent-warning) !important;
        background: rgba(245, 158, 11, 0.1) !important;
    }

    /* 背景色 */
    .bg-light {
        background: var(--bg-tertiary) !important;
    }

    .bg-white {
        background: var(--bg-secondary) !important;
    }

    /* 文本颜色 */
    .text-primary {
        color: var(--accent-primary) !important;
    }

    /* 隐藏侧边栏滚动条样式 */
    #sidebar::-webkit-scrollbar {
        width: 0px;
    }

    /* Accordion手风琴样式 */
    .accordion-item {
        background: var(--bg-secondary) !important;
        border: 1px solid var(--border-color) !important;
    }

    .accordion-button {
        background: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
        border: none !important;
    }

    .accordion-button:not(.collapsed) {
        background: var(--bg-elevated) !important;
        color: var(--accent-primary) !important;
        box-shadow: none !important;
    }

    .accordion-button:focus {
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1) !important;
    }

    .accordion-button::after {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .accordion-body {
        background: var(--bg-secondary) !important;
        color: var(--text-secondary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- 左侧导航 -->
    <div id="sidebar">
        <!-- 基础分析区 -->
        <div class="sidebar-header">基础分析</div>
        <a class="nav-link-sidebar" data-module="descriptive" onclick="switchModule('descriptive')">
            <i class="fa-solid fa-chart-simple"></i>
            <span>描述性统计</span>
        </a>
        <a class="nav-link-sidebar" data-module="grouped-descriptive" onclick="switchModule('grouped-descriptive')">
            <i class="fa-solid fa-chart-column"></i>
            <span>分组描述性统计</span>
        </a>
        <a class="nav-link-sidebar" data-module="frequency" onclick="switchModule('frequency')">
            <i class="fa-solid fa-table-list"></i>
            <span>频数统计</span>
        </a>
        <a class="nav-link-sidebar" data-module="correlation" onclick="switchModule('correlation')">
            <i class="fa-solid fa-link"></i>
            <span>相关性分析</span>
        </a>
        <a class="nav-link-sidebar" data-module="vif" onclick="switchModule('vif')">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>VIF 共线性检验</span>
        </a>

        <hr style="border-color: var(--border-color); margin: 10px 0;">

        <!-- 回归模型区 -->
        <div class="sidebar-header">回归模型</div>
        <a class="nav-link-sidebar active" data-module="regression" data-method="ols" onclick="switchModule('regression', 'ols')">
            <i class="fa-solid fa-chart-line"></i>
            <span>线性 OLS 回归</span>
        </a>
        <a class="nav-link-sidebar" data-module="regression" data-method="fe" onclick="switchModule('regression', 'fe')">
            <i class="fa-solid fa-building"></i>
            <span>固定效应模型</span>
        </a>
        <a class="nav-link-sidebar" data-module="regression" data-method="re" onclick="switchModule('regression', 're')">
            <i class="fa-solid fa-shuffle"></i>
            <span>随机效应模型</span>
        </a>
        <a class="nav-link-sidebar" data-module="regression" data-method="pooled" onclick="switchModule('regression', 'pooled')">
            <i class="fa-solid fa-layer-group"></i>
            <span>混合效应模型</span>
        </a>
        <a class="nav-link-sidebar" data-module="regression" data-method="logit" onclick="switchModule('regression', 'logit')">
            <i class="fa-solid fa-circle-check"></i>
            <span>Logit 模型</span>
        </a>
        <a class="nav-link-sidebar" data-module="regression" data-method="probit" onclick="switchModule('regression', 'probit')">
            <i class="fa-solid fa-circle-dot"></i>
            <span>Probit 模型</span>
        </a>

        <hr style="border-color: var(--border-color); margin: 10px 0;">

        <!-- 模型检验区 -->
        <div class="sidebar-header">模型检验</div>
        <a class="nav-link-sidebar" data-module="test" data-method="f_test" onclick="switchModule('test', 'f_test')">
            <i class="fa-solid fa-flask"></i>
            <span>F检验 (FE vs Pooled)</span>
        </a>
        <a class="nav-link-sidebar" data-module="test" data-method="hausman" onclick="switchModule('test', 'hausman')">
            <i class="fa-solid fa-vial"></i>
            <span>Hausman检验 (FE vs RE)</span>
        </a>
    </div>

    <!-- 右侧内容 -->
    <div class="content-area">
        {% if not current_user.is_authenticated %}
        <div class="alert alert-warning text-center py-2 mb-3"><small>⚠️ 游客模式下无法保存历史记录。</small></div>
        {% endif %}

        <!-- 文件上传 -->
        <div class="card mb-3 shadow-sm border-warning" id="upload-card">
            <div class="card-body py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span id="file-status" class="fw-bold text-warning me-2" style="font-size: 1.1rem;">
                        <i class="bi bi-exclamation-triangle-fill"></i> 请先上传数据文件
                    </span>
                    <div id="upload-loading" class="spinner-border spinner-border-sm text-primary" style="display:none;"></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button id="btn-preview" class="btn btn-sm btn-outline-primary" style="display:none;" onclick="previewData()">预览数据</button>
                    <input type="file" id="fileInput" class="form-control form-control-sm" style="width: auto;" accept=".csv, .xlsx, .dta">
                </div>
            </div>
        </div>

        <!-- 模块容器 -->
        <div id="modules-container">
            <!-- 各个模块将通过include加载 -->
            {% include 'analysis_modules/descriptive.html' %}
            {% include 'analysis_modules/grouped_descriptive.html' %}
            {% include 'analysis_modules/frequency.html' %}
            {% include 'analysis_modules/correlation.html' %}
            {% include 'analysis_modules/vif.html' %}
            {% include 'analysis_modules/regression.html' %}
            {% include 'analysis_modules/model_test.html' %}
        </div>
    </div>
</div>

<!-- 数据预览模态框 -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">数据预览 (前10行)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    window.currentFilename = "";
    let columnNames = [];
    let currentActiveModule = "regression";

    // HTML转义辅助函数
    function escapeHtml(str) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '/': '&#x2F;' };
        return String(str).replace(/[&<>"'/]/g, (c) => map[c]);
    }

    // 单元格格式化函数
    function formatCell(value, dtype) {
        if (value === null || value === undefined) return '';
        if (dtype.startsWith('float')) {
            let num = Number(value);
            if (isNaN(num)) return String(value);
            if (Math.abs(num) >= 1e6 || (Math.abs(num) <= 1e-4 && num !== 0)) {
                return num.toExponential(2);
            } else {
                return num.toFixed(2);
            }
        } else if (dtype.startsWith('int') || dtype.startsWith('uint')) {
            let num = Number(value);
            if (isNaN(num)) return String(value);
            if (Math.abs(num) >= 1e8) {
                return num.toExponential(2);
            } else {
                return num.toString();
            }
        } else if (dtype === 'object' || dtype === 'string' || dtype === 'category') {
            let str = String(value);
            if (str.length > 5) {
                return '#'.repeat(5);
            } else {
                return str;
            }
        } else {
            return String(value);
        }
    }

    // 文件上传监听
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        
        const statusSpan = document.getElementById('file-status');
        const loader = document.getElementById('upload-loading');
        
        statusSpan.innerText = "正在上传解析...";
        loader.style.display = 'inline-block';
        document.getElementById('fileInput').disabled = true;

        fetch('/upload', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                alert('上传错误: ' + d.error);
                statusSpan.innerText = "上传失败";
                statusSpan.className = "fw-bold text-danger me-2";
            } else {
                window.currentFilename = d.filename;
                columnNames = d.columns;
                statusSpan.innerHTML = `<i class="bi bi-check-circle-fill"></i> 当前数据: ${d.filename}`;
                statusSpan.className = "fw-bold text-success me-2";
                
                // 修改卡片边框颜色为绿色
                document.getElementById('upload-card').className = "card mb-3 shadow-sm border-success";
                
                // 初始化所有模块
                initAllModules(columnNames);
                
                // 显示当前激活的模块并展开配置面板
                showCurrentModule();
                
                // 展开当前模块的配置面板
                expandCurrentModulePanel();
                
                document.getElementById('btn-preview').style.display = 'inline-block';
            }
        })
        .catch(e => alert("网络错误"))
        .finally(() => {
            loader.style.display = 'none';
            document.getElementById('fileInput').disabled = false;
        });
    });

    // 初始化所有模块
    function initAllModules(columns) {
        if (typeof initDescriptiveModule === 'function') initDescriptiveModule(columns);
        if (typeof initGroupedDescriptiveModule === 'function') initGroupedDescriptiveModule(columns);
        if (typeof initFrequencyModule === 'function') initFrequencyModule(columns);
        if (typeof initCorrelationModule === 'function') initCorrelationModule(columns);
        if (typeof initVIFModule === 'function') initVIFModule(columns);
        if (typeof initRegressionModule === 'function') initRegressionModule(columns);
        if (typeof initTestModule === 'function') initTestModule(columns);
    }

    // 切换模块
    function switchModule(moduleName, method) {
        // 更新导航栏激活状态
        document.querySelectorAll('.nav-link-sidebar').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        // 隐藏所有模块
        document.querySelectorAll('.analysis-module').forEach(el => {
            el.classList.remove('active');
        });
        
        // 显示目标模块
        const targetModule = document.getElementById(`module-${moduleName}`);
        if (targetModule) {
            targetModule.classList.add('active');
            currentActiveModule = moduleName;
            
            // 如果是回归或检验模块，设置具体方法
            if (moduleName === 'regression' && method && typeof setRegressionMethod === 'function') {
                setRegressionMethod(method);
            } else if (moduleName === 'test' && method && typeof setTestMethod === 'function') {
                setTestMethod(method);
            }
            
            // 如果已上传数据，自动展开配置面板
            if (window.currentFilename) {
                const panelId = `${moduleName}-config-body`;
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'block';
                }
            }
        }
    }

    // 显示当前激活的模块
    function showCurrentModule() {
        const targetModule = document.getElementById(`module-${currentActiveModule}`);
        if (targetModule) {
            targetModule.classList.add('active');
            
            // 默认显示OLS回归
            if (currentActiveModule === 'regression' && typeof setRegressionMethod === 'function') {
                setRegressionMethod('ols');
            }
        }
    }
    
    // 展开当前模块的配置面板
    function expandCurrentModulePanel() {
        const panelId = `${currentActiveModule}-config-body`;
        const panel = document.getElementById(panelId);
        if (panel) {
            panel.style.display = 'block';
        }
    }

    // 数据预览
    function previewData() {
        if (!window.currentFilename) {
            alert('没有上传文件');
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        const modalBody = document.querySelector('#previewModal .modal-body');
        modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p>加载中...</p></div>';
        modal.show();
        
        fetch(`/preview?filename=${encodeURIComponent(window.currentFilename)}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>';
                data.columns.forEach(col => {
                    html += `<th title="类型: ${data.dtypes[col]}">${escapeHtml(col)}</th>`;
                });
                html += '</tr></thead><tbody>';
                data.preview.forEach(row => {
                    html += '<tr>';
                    data.columns.forEach(col => {
                        let val = row[col];
                        let rawAttr = `data-raw="${encodeURIComponent(JSON.stringify(val))}" data-dtype="${data.dtypes[col]}"`;
                        html += `<td ${rawAttr}>${escapeHtml(formatCell(val, data.dtypes[col]))}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
                
                // 双击切换显示原始值
                modalBody.addEventListener('dblclick', function(e) {
                    const td = e.target.closest('td');
                    if (!td) return;
                    const raw = decodeURIComponent(td.getAttribute('data-raw'));
                    let original;
                    try {
                        original = JSON.parse(raw);
                    } catch {
                        original = raw;
                    }
                    const currentText = td.textContent;
                    const originalText = (original === null || original === undefined) ? '' : String(original);
                    if (currentText === originalText) {
                        td.textContent = formatCell(original, td.getAttribute('data-dtype'));
                    } else {
                        td.textContent = originalText;
                    }
                });
            })
            .catch(err => modalBody.innerHTML = `<div class="alert alert-danger">请求失败: ${err}</div>`);
    }

    // 页面加载时默认显示回归模块（但不展开配置面板）
    document.addEventListener('DOMContentLoaded', function() {
        showCurrentModule();
        // 未上传数据时，默认折叠所有配置面板
        collapseAllModulePanels();
    });
    
    // 折叠所有模块的配置面板
    function collapseAllModulePanels() {
        const panelIds = [
            'descriptive-config-body',
            'grouped-descriptive-config-body',
            'frequency-config-body',
            'correlation-config-body',
            'vif-config-body',
            'regression-config-body',
            'test-config-body'
        ];
        panelIds.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) {
                panel.style.display = 'none';
            }
        });
    }
</script>

<!-- 导出功能依赖库 -->
<script src="{{ url_for('static', filename='js/FileSaver.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/html-docx.js') }}"></script>
<script src="{{ url_for('static', filename='js/xlsx.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
{% endblock %}
