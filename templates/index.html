<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STATAU - Advanced</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    
    <style>
        /* ... ä¹‹å‰çš„æ ·å¼ä¿ç•™ ... */
        body { background-color: #f4f6f9; min-height: 100vh; display: flex; flex-direction: column; }
        .main-container { flex: 1; display: flex; overflow: hidden; height: 100vh; }
        #sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; flex-shrink: 0; overflow-y: auto; }
        .nav-link { color: #bdc3c7; cursor: pointer; padding: 15px 20px; }
        .nav-link:hover, .nav-link.active { color: white; background-color: #1abc9c; }
        .content-area { flex: 1; padding: 20px; overflow-y: auto; }
        .var-list-container { border: 1px solid #ced4da; height: 150px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px; }
        
        /* è¡¨æ ¼ç‰¹æ®Šæ ·å¼ */
        .table-editable-container { text-align: center; margin-top: 20px; }
        .table-title-input {
            border: none; background: transparent; 
            font-size: 1.2em; font-weight: bold; text-align: center; 
            width: 80%; margin-bottom: 10px; border-bottom: 1px dashed #ccc;
        }
        .table-title-input:focus { outline: none; border-bottom: 1px solid #000; }
        
        .academic-table { 
            border-collapse: collapse; margin: 0 auto; 
            font-family: "Times New Roman", serif; font-size: 1.05em;
            background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-width: 60%;
        }
        .academic-table td, .academic-table th { padding: 4px 12px; } /* æ›´ç´§å‡‘ */
    </style>
</head>
<body>

<div class="main-container">
    <div id="sidebar">
        <h4 class="text-center mb-4 fw-bold">STATAU</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" onclick="selectMethod('ols')">çº¿æ€§OLSå›å½’</a></li>
            <li class="nav-item"><a class="nav-link" onclick="selectMethod('logit')">Logit æ¨¡å‹</a></li>
            <!-- å…¶ä»–æ¨¡å‹çœç•¥ -->
        </ul>
    </div>

    <div class="content-area">
        <!-- æ–‡ä»¶ä¸Šä¼  -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body py-2 d-flex justify-content-between align-items-center">
                <span id="file-status" class="fw-bold text-primary">è¯·å…ˆä¸Šä¼ æ•°æ®</span>
                <input type="file" id="fileInput" class="form-control form-control-sm w-50" accept=".csv, .xlsx, .dta">
            </div>
        </div>

        <!-- å˜é‡é¢æ¿ -->
        <div id="setup-panel" class="card shadow-sm mb-4" style="display:none;">
            <div class="card-header bg-white d-flex justify-content-between" onclick="togglePanel()">
                <h5 class="m-0 text-primary" id="method-title">å˜é‡é…ç½®</h5>
                <button class="btn btn-sm btn-light">æŠ˜å /å±•å¼€</button>
            </div>
            <div class="card-body" id="config-body">
                
                <!-- å˜é‡é€‰æ‹©åŒº (ä¿æŒä¸å˜) -->
                <div class="row g-3">
                    <div class="col-md-12">
                        <label>å› å˜é‡ (Y) <span class="text-danger">*</span></label>
                        <select id="y-var-select" class="form-select"></select>
                    </div>
                    <div class="col-md-6">
                        <label>è‡ªå˜é‡ (X) - åˆ—è¡¨é€‰æ‹©</label>
                        <div id="x-var-container" class="var-list-container"></div>
                    </div>
                    <div class="col-md-6">
                        <label>æ§åˆ¶å˜é‡ - åˆ—è¡¨é€‰æ‹©</label>
                        <div id="c-var-container" class="var-list-container"></div>
                    </div>
                    <div class="col-md-12">
                        <label class="small text-muted">æ‰‹åŠ¨è¾“å…¥æ§åˆ¶å˜é‡ (ç©ºæ ¼æˆ–é€—å·åˆ†éš”)</label>
                        <input type="text" id="manual-controls" class="form-control" placeholder="age gender gdp...">
                    </div>
                </div>

                <hr class="my-4">

                <!-- å¯¼å‡ºé€‰é¡¹ (æ¢å¤çš„éƒ¨åˆ†!) -->
                <div class="mb-3">
                    <label class="fw-bold small mb-2">ğŸ“Š ç»“æœè¡¨æ ¼å¯¼å‡ºå†…å®¹ (Export Statistics):</label>
                    <div class="d-flex flex-wrap gap-3 p-2 bg-light rounded border">
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="nobs" checked disabled>
                            <label class="form-check-label">æ ·æœ¬é‡ (N)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="r2" checked id="chk-r2">
                            <label class="form-check-label" for="chk-r2">RÂ² / Pseudo RÂ²</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="adj_r2" checked id="chk-adj">
                            <label class="form-check-label" for="chk-adj">Adj. RÂ²</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="f_stat" checked id="chk-f">
                            <label class="form-check-label" for="chk-f">F ç»Ÿè®¡é‡</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="aic" id="chk-aic">
                            <label class="form-check-label" for="chk-aic">AIC</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="bic" id="chk-bic">
                            <label class="form-check-label" for="chk-bic">BIC</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input export-opt" type="checkbox" value="ll" id="chk-ll">
                            <label class="form-check-label" for="chk-ll">Log Likelihood</label>
                        </div>
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½® (å°æ•°ä½ç­‰) -->
                <div class="accordion mb-3" id="advAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed py-2 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#advConfig">
                                âš™ï¸ æ ¼å¼é«˜çº§è®¾ç½® (å°æ•°ä½ã€æ ‡å‡†è¯¯ç­‰)
                            </button>
                        </h2>
                        <div id="advConfig" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="row align-items-end">
                                    <div class="col-md-3">
                                        <label class="small">å°æ•°ä½æ•°</label>
                                        <input type="number" id="decimal-input" class="form-control form-control-sm" value="3" min="1" max="6">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small d-block">æ‹¬å·å†…æ˜¾ç¤º</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="se_opt" id="show_se" checked>
                                            <label class="form-check-label small" for="show_se">æ ‡å‡†è¯¯ (SE)</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="se_opt" id="show_t">
                                            <label class="form-check-label small" for="show_t">t å€¼</label>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="small">è¡¨æ ¼é»˜è®¤æ ‡é¢˜</label>
                                        <input type="text" id="default-title" class="form-control form-control-sm" value="Regression Results">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-grow-1 fw-bold" onclick="runAnalysis('new')">ğŸ†• å¼€å§‹æ–°åˆ†æ (è¦†ç›–)</button>
                    <button class="btn btn-outline-success flex-grow-1 fw-bold" onclick="runAnalysis('append')">â• æ·»åŠ ä¸€åˆ— (Append)</button>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="result-container" style="display:none; padding-bottom: 50px;">
            <div class="d-flex justify-content-center gap-3 mb-3">
                <button class="btn btn-sm btn-outline-primary" onclick="togglePanel(true)">é‡æ–°é…ç½®å˜é‡</button>
                <button class="btn btn-sm btn-info text-white" onclick="showRaw()">æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡å›å½’è¯¦æƒ…</button>
            </div>
            <div id="table-output"></div>
        </div>
    </div>
</div>

<!-- è¯¦æƒ…æ¨¡æ€æ¡†ç•¥ï¼Œä¸ä¹‹å‰ç›¸åŒ -->
<div class="modal fade" id="rawModal"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-body"><pre id="raw-text"></pre></div></div></div></div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
    let currentFilename = "";
    let currentMethod = "ols";
    let columnNames = [];
    let lastRawOutput = "";

    // æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ†ä¿æŒä¸å˜...
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const fd = new FormData(); fd.append('file', e.target.files[0]);
        fetch('/upload', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
            currentFilename = d.filename; columnNames = d.columns;
            document.getElementById('file-status').innerText = d.filename;
            initUI();
            document.getElementById('setup-panel').style.display = 'block';
        });
    });

    function initUI() {
        const ySel = document.getElementById('y-var-select');
        const xCon = document.getElementById('x-var-container');
        const cCon = document.getElementById('c-var-container');
        ySel.innerHTML = ''; xCon.innerHTML = ''; cCon.innerHTML = '';
        
        columnNames.forEach(col => {
            ySel.add(new Option(col, col));
            xCon.innerHTML += `<div class="form-check"><input class="form-check-input x-box" type="checkbox" value="${col}"><label>${col}</label></div>`;
            cCon.innerHTML += `<div class="form-check"><input class="form-check-input c-box" type="checkbox" value="${col}"><label>${col}</label></div>`;
        });
    }

    // è¿è¡Œåˆ†æ
    function runAnalysis(actionType) {
        const yVar = document.getElementById('y-var-select').value;
        const xVars = Array.from(document.querySelectorAll('.x-box:checked')).map(e=>e.value);
        const cVars = Array.from(document.querySelectorAll('.c-box:checked')).map(e=>e.value);
        const manual = document.getElementById('manual-controls').value;
        
        // è·å–å¯¼å‡ºé€‰é¡¹
        const exportOpts = ['nobs']; // é»˜è®¤å¿…é¡»æœ‰ N
        document.querySelectorAll('.export-opt:checked').forEach(cb => {
            if(cb.value !== 'nobs') exportOpts.push(cb.value);
        });

        const decimals = document.getElementById('decimal-input').value;
        const showSe = document.getElementById('show_se').checked;
        const tableTitle = document.getElementById('default-title').value;

        // DEBUG: æ‰“å°ä¸€ä¸‹å½“å‰çš„æ–¹æ³•ï¼Œé˜²æ­¢è·‘é”™
        console.log("Running method:", currentMethod);

        fetch('/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: actionType,
                filename: currentFilename,
                method: currentMethod, // å…³é”®ï¼šç¡®ä¿è¿™é‡Œä¼ çš„æ˜¯æ­£ç¡®çš„å€¼
                y_var: yVar,
                x_vars: xVars.concat(cVars),
                manual_controls: manual,
                decimals: decimals,
                show_se: showSe,
                table_title: tableTitle,
                export_options: exportOpts // ä¼ é€’é€‰é¡¹
            })
        })
        .then(r => r.json())
        .then(data => {
            if(data.error) {
                alert("åˆ†æé”™è¯¯: " + data.error);
                // å¦‚æœå‡ºç° unit interval é”™è¯¯ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥æ–¹æ³•
                if(data.error.includes("unit interval")) {
                    alert("æç¤ºï¼šæ£€æµ‹åˆ° Logit/Probit æ¨¡å‹é”™è¯¯ã€‚è¯·ç¡®è®¤æ‚¨å·¦ä¾§å¯¼èˆªæ é€‰æ‹©çš„æ˜¯ 'çº¿æ€§OLSå›å½’'ï¼Œæˆ–è€…æ£€æŸ¥æ‚¨çš„å› å˜é‡æ˜¯å¦ä¸º 0/1 å˜é‡ã€‚");
                }
            } else {
                document.getElementById('table-output').innerHTML = data.html_table;
                lastRawOutput = data.raw_output;
                document.getElementById('result-container').style.display = 'block';
                if(actionType === 'new') togglePanel(false);
            }
        });
    }


    function togglePanel(forceOpen) {
        const b = document.getElementById('config-body');
        if(forceOpen === true || b.style.display === 'none') b.style.display = 'block';
        else b.style.display = 'none';
    }
    
    // å·¦ä¾§æ¨¡å‹é€‰æ‹©
    // ç¡®ä¿ç‚¹å‡»å·¦ä¾§å¯¼èˆªæ æ—¶ï¼ŒcurrentMethod è¢«æ­£ç¡®æ›´æ–°
    function selectMethod(m) { 
        currentMethod = m; 
        console.log("Method switched to:", currentMethod); // Debug
        
        // æ›´æ–° UI é«˜äº®
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        // æ›´æ–°æ ‡é¢˜
        const names = {'ols': 'çº¿æ€§OLSå›å½’', 'logit': 'Logit æ¨¡å‹', 'probit': 'Probit æ¨¡å‹', 'fe': 'å›ºå®šæ•ˆåº”'};
        document.getElementById('method-title').innerText = names[m] + " - å˜é‡é…ç½®";
        
        togglePanel(true); 
    }

    function showRaw() { 
        document.getElementById('raw-text').innerText = lastRawOutput; 
        new bootstrap.Modal(document.getElementById('rawModal')).show(); 
    }
</script>
</body>
</html>