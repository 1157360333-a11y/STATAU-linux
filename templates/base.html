<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STATAU - {% block title %}é¦–é¡µ{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-icons/bootstrap-icons.css') }}">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- æ–°ä¸»é¢˜CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-dark.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/charts.css') }}">

    <style>
        body { padding-top: 56px; }
        .navbar-brand { font-weight: bold; color: #fff !important; }
        .nav-link { color: rgba(255,255,255,0.8) !important; }
        .nav-link:hover, .nav-link.active { color: #fff !important; font-weight: 500; }
        
    /* --- å…¨æ–°ç™»å½•æ³¨å†Œæ¨¡æ€æ¡†è®¾è®¡ --- */
    .auth-modal-content {
        border-radius: 20px;
        overflow: hidden;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        max-height: 85vh;
        overflow-y: auto;
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }
    .auth-modal-content::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
    .auth-header {
        background: var(--gradient-primary);
        color: white;
        padding: 20px 20px;
        text-align: center;
        position: relative;
    }
    .auth-header::after {
        content: '';
        position: absolute;
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 30px;
        background: white;
        border-radius: 50%;
    }
    .auth-header h5 {
        margin: 0;
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: 1px;
    }
    .auth-header small {
        opacity: 0.9;
        font-size: 0.85rem;
    }
    
    /* åˆ‡æ¢æŒ‰é’®æ ·å¼ - å¼ºåˆ¶è¦†ç›–æ‰€æœ‰Bootstrapæ ·å¼ */
    .nav-pills-custom {
        justify-content: center;
        margin-top: 15px;
        margin-bottom: 15px;
        position: relative;
        z-index: 10;
    }
    #authModal .nav-pills-custom .nav-item button.nav-link {
        color: #333333 !important;
        background-color: transparent !important;
        background: transparent !important;
        border-radius: 30px;
        padding: 8px 25px;
        font-weight: 600;
        margin: 0 6px;
        transition: all 0.3s ease;
        border: 2px solid #e1e5e9 !important;
        -webkit-text-fill-color: #333333 !important;
        opacity: 1 !important;
    }
    #authModal .nav-pills-custom .nav-item button.nav-link.active {
        color: var(--accent-primary) !important;
        -webkit-text-fill-color: var(--accent-primary) !important;
        background-color: transparent !important;
        background: transparent !important;
        border-color: var(--accent-primary) !important;
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
    }
    #authModal .nav-pills-custom .nav-item button.nav-link:hover:not(.active) {
        color: var(--accent-primary) !important;
        -webkit-text-fill-color: var(--accent-primary) !important;
        border-color: #ddd !important;
    }
    /* ç¡®ä¿æŒ‰é’®å†…éƒ¨æ–‡å­—ä¸ä¼šè¢«ä»»ä½•æ ·å¼è¦†ç›– */
    #authModal .nav-pills-custom .nav-item button.nav-link span,
    #authModal .nav-pills-custom .nav-item button.nav-link:after,
    #authModal .nav-pills-custom .nav-item button.nav-link:before {
        color: inherit !important;
        -webkit-text-fill-color: inherit !important;
    }
    
    /* è¡¨å•å®¹å™¨ */
    .auth-form-container {
        padding: 0 25px 25px;
    }
    
    /* è¾“å…¥æ¡†æ ·å¼ */
    .form-group-auth {
        margin-bottom: 18px;
        position: relative;
    }
    .form-group-auth label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
    }
    .input-group-auth {
        position: relative;
        display: flex;
        align-items: center;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        padding: 0 12px;
        transition: all 0.3s ease;
        background: white;
    }
    .input-group-auth:focus-within {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    .input-group-auth i {
        color: var(--accent-primary);
        font-size: 1rem;
        margin-right: 10px;
    }
    .input-group-auth input {
        flex: 1;
        border: none;
        padding: 12px 0;
        font-size: 0.95rem;
        background: transparent;
        outline: none;
        color: #333;
    }
    .input-group-auth input::placeholder {
        color: #aaa;
    }
    
    /* éªŒè¯ç åŒºåŸŸ */
    .captcha-container {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    .captcha-input {
        flex: 1;
    }
    .captcha-image-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    .captcha-img {
        height: 50px;
        border-radius: 6px;
        border: 2px solid #e1e5e9;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .captcha-img:hover {
        border-color: var(--accent-primary);
        transform: translateY(-2px);
    }
    .captcha-refresh {
        background: none;
        border: none;
        color: var(--accent-primary);
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .auth-btn {
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .btn-login {
        background: var(--gradient-primary);
        color: white;
    }
    .btn-login:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 212, 255, 0.3);
    }
    .btn-login:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    .btn-register {
        background: linear-gradient(135deg, var(--accent-success) 0%, #96c93d 100%);
        color: white;
    }
    .btn-register:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }
    .btn-register:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .btn-spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* é”™è¯¯æç¤º */
    .error-message {
        color: #ff4757;
        font-size: 0.8rem;
        margin-top: 4px;
        display: none;
    }
    
    /* æ¨¡æ€æ¡†å¤§å°è°ƒæ•´ */
    .auth-modal-dialog {
        max-width: 460px;
        margin: 1.75rem auto;
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 576px) {
        .auth-form-container {
            padding: 0 20px 20px;
        }
        #authModal .nav-pills-custom .nav-item button.nav-link {
            padding: 6px 20px;
            margin: 0 4px;
            font-size: 0.9rem;
        }
        .auth-modal-dialog {
            max-width: 90%;
            margin: 1rem auto;
        }
        .auth-header {
            padding: 15px 20px;
        }
    }
    </style>
    {% block styles %}{% endblock %}
</head>
<body>

<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-tech fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">STATAU</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link {% if active_page == 'home' %}active{% endif %}" href="/">é¦–é¡µ</a></li>
                <!-- æ•°æ®åˆ†æé“¾æ¥ï¼šæœªç™»å½•æ—¶æ‹¦æˆªå¹¶å¼¹å‡ºç™»å½•æ¡† -->
                <li class="nav-item">
                    {% if current_user.is_authenticated %}
                    <a class="nav-link {% if active_page == 'analysis' %}active{% endif %}" href="/analysis">æ•°æ®åˆ†æ</a>
                    {% else %}
                    <a class="nav-link {% if active_page == 'analysis' %}active{% endif %}" href="javascript:void(0)" onclick="requireLogin()">æ•°æ®åˆ†æ</a>
                    {% endif %}
                </li>
                <li class="nav-item"><a class="nav-link {% if active_page == 'database' %}active{% endif %}" href="/database">æ•°æ®åº“</a></li>
                <li class="nav-item"><a class="nav-link {% if active_page == 'help' %}active{% endif %}" href="/help">å¸®åŠ©æ‰‹å†Œ</a></li>
                <!-- ç®¡ç†åå°å…¥å£ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <li class="nav-item"><a class="nav-link {% if active_page == 'admin' %}active{% endif %}" href="/admin" style="color: #ffd700 !important;"><i class="fa-light fa-shield-halved"></i> ç®¡ç†åå°</a></li>
                {% endif %}
            </ul>
            <ul class="navbar-nav ms-auto">
                {% if current_user.is_authenticated %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fa-light fa-circle-user"></i> {{ current_user.username }}
                        {% if current_user.role == 'admin' %}
                        <span class="badge bg-warning text-dark ms-1">ç®¡ç†å‘˜</span>
                        {% endif %}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#">ä¸ªäººä¸­å¿ƒ</a></li>
                        {% if current_user.role == 'admin' %}
                        <li><a class="dropdown-item" href="/admin"><i class="fa-light fa-shield-halved"></i> ç®¡ç†åå°</a></li>
                        <li><hr class="dropdown-divider"></li>
                        {% endif %}
                        <li><a class="dropdown-item text-danger" href="/api/logout">é€€å‡ºç™»å½•</a></li>
                    </ul>
                </li>
                {% else %}
                <li class="nav-item">
                    <button class="btn btn-outline-light btn-sm ms-2" onclick="openAuthModal('login')">ç™»å½• / æ³¨å†Œ</button>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

{% block content %}{% endblock %}

<!-- ç™»å½•/æ³¨å†Œ æ¨¡æ€æ¡† -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog auth-modal-dialog">
        <div class="modal-content auth-modal-content">
            <!-- é¡¶éƒ¨è£…é¥° -->
            <div class="auth-header">
                <h5>STATAU</h5>
                <small>äº‘ç«¯è®¡é‡ç»æµå­¦å¹³å°</small>
            </div>
            
            <div class="auth-form-container">
                <!-- åˆ‡æ¢æŒ‰é’® -->
                <ul class="nav nav-pills nav-pills-custom" id="authTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#login-tab" type="button">ç™»å½•</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#register-tab" type="button" onclick="refreshCaptcha()">æ³¨å†Œ</button>
                    </li>
                </ul>

                <div class="tab-content mt-4">
                    <!-- ç™»å½•è¡¨å• -->
                    <div class="tab-pane fade show active" id="login-tab">
                        <!-- ç™»å½•æ–¹å¼åˆ‡æ¢ -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div class="btn-group" role="group" style="width: 100%;">
                                <button type="button" class="btn btn-outline-primary" id="btn-password-login" onclick="switchLoginMode('password')" style="flex: 1; border-radius: 8px 0 0 8px;">
                                    <i class="bi bi-key"></i> å¯†ç ç™»å½•
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="btn-code-login" onclick="switchLoginMode('code')" style="flex: 1; border-radius: 0 8px 8px 0;">
                                    <i class="bi bi-envelope-check"></i> éªŒè¯ç ç™»å½•
                                </button>
                            </div>
                        </div>
                        
                        <!-- å¯†ç ç™»å½•è¡¨å• -->
                        <div id="password-login-form">
                            <div class="form-group-auth">
                                <label for="login-user">ç”¨æˆ·å / é‚®ç®±</label>
                                <div class="input-group-auth">
                                    <i class="bi bi-person"></i>
                                    <input type="text" id="login-user" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                                </div>
                                <div class="error-message" id="login-user-error"></div>
                            </div>
                            
                            <div class="form-group-auth">
                                <label for="login-pass">å¯†ç </label>
                                <div class="input-group-auth">
                                    <i class="bi bi-lock"></i>
                                    <input type="password" id="login-pass" placeholder="è¯·è¾“å…¥å¯†ç ">
                                </div>
                                <div class="error-message" id="login-pass-error"></div>
                            </div>
                            
                            <!-- ç™»å½•æŒ‰é’®ï¼šæ”¯æŒåŠ è½½çŠ¶æ€ -->
                            <button class="auth-btn btn-login" id="btn-login" onclick="handleLogin()">
                                <span class="btn-spinner" style="display: none;"></span>
                                <span class="btn-text">ç«‹å³ç™»å½•</span>
                            </button>
                        </div>
                        
                        <!-- éªŒè¯ç ç™»å½•è¡¨å• -->
                        <div id="code-login-form" style="display: none;">
                            <div class="form-group-auth">
                                <label for="login-email">é‚®ç®±åœ°å€</label>
                                <div class="input-group-auth">
                                    <i class="bi bi-envelope"></i>
                                    <input type="email" id="login-email" placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±">
                                </div>
                                <div class="error-message" id="login-email-error"></div>
                            </div>
                            
                            <div class="form-group-auth">
                                <label for="login-code">é‚®ç®±éªŒè¯ç </label>
                                <div style="display: flex; gap: 10px; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div class="input-group-auth">
                                            <i class="bi bi-shield-check"></i>
                                            <input type="text" id="login-code" placeholder="è¯·è¾“å…¥éªŒè¯ç ">
                                        </div>
                                        <div class="error-message" id="login-code-error"></div>
                                    </div>
                                    <button type="button" id="btn-send-login-code" class="btn btn-outline-primary" style="white-space: nowrap; padding: 12px 20px; border-radius: 10px; font-weight: 600;" onclick="sendLoginCode()">
                                        å‘é€éªŒè¯ç 
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ç™»å½•æŒ‰é’®ï¼šæ”¯æŒåŠ è½½çŠ¶æ€ -->
                            <button class="auth-btn btn-login" id="btn-code-login-submit" onclick="handleCodeLogin()">
                                <span class="btn-spinner" style="display: none;"></span>
                                <span class="btn-text">ç«‹å³ç™»å½•</span>
                            </button>
                        </div>
                    </div>

                    <!-- æ³¨å†Œè¡¨å• -->
                    <div class="tab-pane fade" id="register-tab">
                        <div class="form-group-auth">
                            <label for="reg-user">ç”¨æˆ·å</label>
                            <div class="input-group-auth">
                                <i class="bi bi-person"></i>
                                <input type="text" id="reg-user" placeholder="è®¾ç½®ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰">
                            </div>
                            <div class="error-message" id="reg-user-error"></div>
                        </div>
                        
                        <div class="form-group-auth">
                            <label for="reg-email">ç”µå­é‚®ç®±</label>
                            <div class="input-group-auth">
                                <i class="bi bi-envelope"></i>
                                <input type="email" id="reg-email" placeholder="è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±åœ°å€ï¼ˆå¿…å¡«ï¼‰">
                            </div>
                            <div class="error-message" id="reg-email-error"></div>
                        </div>
                        
                        <!-- é‚®ç®±éªŒè¯ç åŒºåŸŸ -->
                        <div class="form-group-auth">
                            <label for="reg-email-code">é‚®ç®±éªŒè¯ç </label>
                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div class="input-group-auth">
                                        <i class="bi bi-envelope-check"></i>
                                        <input type="text" id="reg-email-code" placeholder="è¯·è¾“å…¥é‚®ç®±éªŒè¯ç ">
                                    </div>
                                    <div class="error-message" id="reg-email-code-error"></div>
                                </div>
                                <button type="button" id="btn-send-code" class="btn btn-outline-primary" style="white-space: nowrap; padding: 12px 20px; border-radius: 10px; font-weight: 600;" onclick="sendEmailCode()">
                                    å‘é€éªŒè¯ç 
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group-auth">
                            <label for="reg-pass">å¯†ç </label>
                            <div class="input-group-auth">
                                <i class="bi bi-lock"></i>
                                <input type="password" id="reg-pass" placeholder="è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                            </div>
                            <div class="error-message" id="reg-pass-error"></div>
                        </div>
                        
                        <div class="form-group-auth">
                            <label for="reg-confirm-pass">ç¡®è®¤å¯†ç </label>
                            <div class="input-group-auth">
                                <i class="bi bi-lock-fill"></i>
                                <input type="password" id="reg-confirm-pass" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                            </div>
                            <div class="error-message" id="reg-confirm-pass-error"></div>
                        </div>
                        
                        <!-- éªŒè¯ç åŒºåŸŸ -->
                        <div class="form-group-auth">
                            <label for="reg-captcha">éªŒè¯ç </label>
                            <div class="captcha-container">
                                <div class="captcha-input">
                                    <div class="input-group-auth">
                                        <i class="bi bi-shield-check"></i>
                                        <input type="text" id="reg-captcha" placeholder="è¯·è¾“å…¥éªŒè¯ç ">
                                    </div>
                                    <div class="error-message" id="reg-captcha-error"></div>
                                </div>
                                <div class="captcha-image-container">
                                    <img src="" id="captcha-img" class="captcha-img" title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç " onclick="refreshCaptcha()" alt="éªŒè¯ç ">
                                    <button type="button" class="captcha-refresh" onclick="refreshCaptcha()">åˆ·æ–°éªŒè¯ç </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ³¨å†ŒæŒ‰é’®ï¼šæ”¯æŒåŠ è½½çŠ¶æ€ -->
                        <button class="auth-btn btn-register" id="btn-register" onclick="handleRegister()">
                            <span class="btn-spinner" style="display: none;"></span>
                            <span class="btn-text">æ³¨å†Œè´¦æˆ·</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
    // ========================================================================
    // åˆ·æ–°éªŒè¯ç 
    // ========================================================================
    function refreshCaptcha() {
        const captchaImg = document.getElementById('captcha-img');
        if (captchaImg) {
            captchaImg.src = '/api/captcha?t=' + new Date().getTime();
            const captchaInput = document.getElementById('reg-captcha');
            if (captchaInput) captchaInput.value = '';
        }
    }

    // ========================================================================
    // é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º/éšè—
    // ========================================================================
    function showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    }

    function hideError(elementId) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
            errorEl.style.display = 'none';
        }
    }

    // ========================================================================
    // æŒ‰é’®åŠ è½½çŠ¶æ€æ§åˆ¶
    // ========================================================================
    function setButtonLoading(btnId, isLoading, loadingText, normalText) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        
        const spinner = btn.querySelector('.btn-spinner');
        const text = btn.querySelector('.btn-text');
        
        if (isLoading) {
            btn.disabled = true;
            if (spinner) spinner.style.display = 'block';
            if (text) text.textContent = loadingText || 'å¤„ç†ä¸­...';
        } else {
            btn.disabled = false;
            if (spinner) spinner.style.display = 'none';
            if (text) text.textContent = normalText || 'æäº¤';
        }
    }

    // ========================================================================
    // ç™»å½•æ–¹å¼åˆ‡æ¢
    // ========================================================================
    function switchLoginMode(mode) {
        const passwordForm = document.getElementById('password-login-form');
        const codeForm = document.getElementById('code-login-form');
        const btnPassword = document.getElementById('btn-password-login');
        const btnCode = document.getElementById('btn-code-login');
        
        if (mode === 'password') {
            passwordForm.style.display = 'block';
            codeForm.style.display = 'none';
            btnPassword.classList.remove('btn-outline-primary');
            btnPassword.classList.add('btn-primary');
            btnCode.classList.remove('btn-primary');
            btnCode.classList.add('btn-outline-secondary');
        } else {
            passwordForm.style.display = 'none';
            codeForm.style.display = 'block';
            btnPassword.classList.remove('btn-primary');
            btnPassword.classList.add('btn-outline-primary');
            btnCode.classList.remove('btn-outline-secondary');
            btnCode.classList.add('btn-primary');
        }
    }

    // ========================================================================
    // å‘é€ç™»å½•éªŒè¯ç 
    // ========================================================================
    function sendLoginCode() {
        const email = document.getElementById('login-email').value.trim();
        const btn = document.getElementById('btn-send-login-code');
        
        // éšè—é”™è¯¯æ¶ˆæ¯
        hideError('login-email-error');
        hideError('login-code-error');
        
        // é‚®ç®±éªŒè¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            showError('login-email-error', 'è¯·å…ˆè¾“å…¥é‚®ç®±åœ°å€');
            return;
        }
        if (!emailRegex.test(email)) {
            showError('login-email-error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
            return;
        }
        
        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºå€’è®¡æ—¶
        btn.disabled = true;
        let countdown = 60;
        const originalText = btn.textContent;
        
        const timer = setInterval(() => {
            btn.textContent = `${countdown}ç§’åé‡è¯•`;
            countdown--;
            
            if (countdown < 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }, 1000);
        
        // å‘é€è¯·æ±‚
        fetch('/api/send_login_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        }).then(r => r.json()).then(d => {
            if (d.status === 'success') {
                showError('login-code-error', 'âœ“ ' + d.message);
                document.getElementById('login-code-error').style.color = '#28a745';
            } else {
                // å‘é€å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = originalText;
                showError('login-email-error', d.error || 'å‘é€å¤±è´¥');
            }
        }).catch(() => {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = originalText;
            showError('login-email-error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // ========================================================================
    // éªŒè¯ç ç™»å½•é€»è¾‘
    // ========================================================================
    function handleCodeLogin() {
        const email = document.getElementById('login-email').value.trim();
        const code = document.getElementById('login-code').value.trim();
        
        // éšè—æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
        hideError('login-email-error');
        hideError('login-code-error');
        
        let hasError = false;
        
        // é‚®ç®±éªŒè¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            showError('login-email-error', 'è¯·è¾“å…¥é‚®ç®±åœ°å€');
            hasError = true;
        } else if (!emailRegex.test(email)) {
            showError('login-email-error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
            hasError = true;
        }
        
        // éªŒè¯ç éªŒè¯
        if (!code) {
            showError('login-code-error', 'è¯·è¾“å…¥éªŒè¯ç ');
            hasError = true;
        } else if (code.length !== 6) {
            showError('login-code-error', 'éªŒè¯ç åº”ä¸º6ä½æ•°å­—');
            hasError = true;
        }
        
        if (hasError) return;
        
        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        setButtonLoading('btn-code-login-submit', true, 'æ­£åœ¨ç™»å½•...', 'ç«‹å³ç™»å½•');
        
        fetch('/api/login_with_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, code: code})
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                // ç™»å½•æˆåŠŸï¼Œåˆ·æ–°é¡µé¢
                location.reload();
            } else {
                // ç™»å½•å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                setButtonLoading('btn-code-login-submit', false, 'æ­£åœ¨ç™»å½•...', 'ç«‹å³ç™»å½•');
                showError('login-code-error', d.error || 'ç™»å½•å¤±è´¥');
            }
        }).catch(() => {
            setButtonLoading('btn-code-login-submit', false, 'æ­£åœ¨ç™»å½•...', 'ç«‹å³ç™»å½•');
            showError('login-code-error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // ========================================================================
    // å¯†ç ç™»å½•é€»è¾‘ï¼ˆå¸¦åŠ è½½çŠ¶æ€ï¼‰
    // ========================================================================
    function handleLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value;
        
        // éšè—æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
        hideError('login-user-error');
        hideError('login-pass-error');
        
        let hasError = false;
        
        if (!u) {
            showError('login-user-error', 'è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±');
            hasError = true;
        }
        if (!p) {
            showError('login-pass-error', 'è¯·è¾“å…¥å¯†ç ');
            hasError = true;
        }
        
        if (hasError) return;
        
        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        setButtonLoading('btn-login', true, 'æ­£åœ¨ç™»å½•...', 'ç«‹å³ç™»å½•');
        
        fetch('/api/login', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: u, password: p})
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                // ç™»å½•æˆåŠŸï¼Œåˆ·æ–°é¡µé¢
                location.reload();
            } else {
                // ç™»å½•å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                setButtonLoading('btn-login', false, 'æ­£åœ¨ç™»å½•...', 'ç«‹å³ç™»å½•');
                showError('login-pass-error', d.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
            }
        }).catch(() => {
            setButtonLoading('btn-login', false, 'æ­£åœ¨ç™»å½•...', 'ç«‹å³ç™»å½•');
            showError('login-pass-error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // ========================================================================
    // å‘é€é‚®ç®±éªŒè¯ç 
    // ========================================================================
    function sendEmailCode() {
        const email = document.getElementById('reg-email').value.trim();
        const btn = document.getElementById('btn-send-code');
        
        // éšè—é”™è¯¯æ¶ˆæ¯
        hideError('reg-email-error');
        hideError('reg-email-code-error');
        
        // é‚®ç®±éªŒè¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            showError('reg-email-error', 'è¯·å…ˆè¾“å…¥é‚®ç®±åœ°å€');
            return;
        }
        if (!emailRegex.test(email)) {
            showError('reg-email-error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
            return;
        }
        
        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºå€’è®¡æ—¶
        btn.disabled = true;
        let countdown = 60;
        const originalText = btn.textContent;
        
        const timer = setInterval(() => {
            btn.textContent = `${countdown}ç§’åé‡è¯•`;
            countdown--;
            
            if (countdown < 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }, 1000);
        
        // å‘é€è¯·æ±‚
        fetch('/api/send_email_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        }).then(r => r.json()).then(d => {
            if (d.status === 'success') {
                showError('reg-email-code-error', 'âœ“ ' + d.message);
                document.getElementById('reg-email-code-error').style.color = '#28a745';
            } else {
                // å‘é€å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®
                clearInterval(timer);
                btn.disabled = false;
                btn.textContent = originalText;
                showError('reg-email-error', d.error || 'å‘é€å¤±è´¥');
            }
        }).catch(() => {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = originalText;
            showError('reg-email-error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // ========================================================================
    // æ³¨å†Œé€»è¾‘ï¼ˆå¸¦åŠ è½½çŠ¶æ€ï¼‰
    // ========================================================================
    function handleRegister() {
        const u = document.getElementById('reg-user').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const p = document.getElementById('reg-pass').value;
        const confirmPass = document.getElementById('reg-confirm-pass').value;
        const captcha = document.getElementById('reg-captcha').value.trim();
        const emailCode = document.getElementById('reg-email-code').value.trim();
        
        // éšè—æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
        hideError('reg-user-error');
        hideError('reg-email-error');
        hideError('reg-pass-error');
        hideError('reg-confirm-pass-error');
        hideError('reg-captcha-error');
        hideError('reg-email-code-error');
        
        let hasError = false;
        
        // ç”¨æˆ·åéªŒè¯
        if (!u) {
            showError('reg-user-error', 'è¯·è¾“å…¥ç”¨æˆ·å');
            hasError = true;
        } else if (u.length < 3) {
            showError('reg-user-error', 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦');
            hasError = true;
        }
        
        // é‚®ç®±éªŒè¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            showError('reg-email-error', 'è¯·è¾“å…¥é‚®ç®±åœ°å€');
            hasError = true;
        } else if (!emailRegex.test(email)) {
            showError('reg-email-error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
            hasError = true;
        }
        
        // å¯†ç éªŒè¯
        if (!p) {
            showError('reg-pass-error', 'è¯·è¾“å…¥å¯†ç ');
            hasError = true;
        } else if (p.length < 6) {
            showError('reg-pass-error', 'å¯†ç é•¿åº¦è‡³å°‘6ä½');
            hasError = true;
        }
        
        // ç¡®è®¤å¯†ç éªŒè¯
        if (!confirmPass) {
            showError('reg-confirm-pass-error', 'è¯·å†æ¬¡è¾“å…¥å¯†ç ');
            hasError = true;
        } else if (p !== confirmPass) {
            showError('reg-confirm-pass-error', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            hasError = true;
        }
        
        // å›¾å½¢éªŒè¯ç éªŒè¯
        if (!captcha) {
            showError('reg-captcha-error', 'è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ');
            hasError = true;
        } else if (captcha.length !== 4) {
            showError('reg-captcha-error', 'å›¾å½¢éªŒè¯ç åº”ä¸º4ä½å­—ç¬¦');
            hasError = true;
        }
        
        // é‚®ç®±éªŒè¯ç éªŒè¯
        if (!emailCode) {
            showError('reg-email-code-error', 'è¯·è¾“å…¥é‚®ç®±éªŒè¯ç ');
            hasError = true;
        } else if (emailCode.length !== 6) {
            showError('reg-email-code-error', 'é‚®ç®±éªŒè¯ç åº”ä¸º6ä½æ•°å­—');
            hasError = true;
        }
        
        if (hasError) return;
        
        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        setButtonLoading('btn-register', true, 'æ­£åœ¨æ³¨å†Œ...', 'æ³¨å†Œè´¦æˆ·');
        
        // å‘é€æ³¨å†Œè¯·æ±‚
        fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: u,
                password: p,
                email: email,
                captcha: captcha,
                email_code: emailCode
            })
        }).then(r => r.json()).then(d => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setButtonLoading('btn-register', false, 'æ­£åœ¨æ³¨å†Œ...', 'æ³¨å†Œè´¦æˆ·');
            
            if(d.status === 'success') {
                alert('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨æ‚¨çš„è´¦æˆ·ç™»å½•ã€‚');
                // è‡ªåŠ¨åˆ‡å›ç™»å½•é¡µ
                const loginTabBtn = document.querySelector('button[data-bs-target="#login-tab"]');
                if (loginTabBtn) {
                    const tab = bootstrap.Tab.getInstance(loginTabBtn) || new bootstrap.Tab(loginTabBtn);
                    tab.show();
                }
                // é¢„å¡«å……ç”¨æˆ·å
                document.getElementById('login-user').value = u;
                document.getElementById('login-pass').value = '';
                // æ¸…ç©ºæ³¨å†Œè¡¨å•
                document.getElementById('reg-user').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-pass').value = '';
                document.getElementById('reg-confirm-pass').value = '';
                document.getElementById('reg-captcha').value = '';
                document.getElementById('reg-email-code').value = '';
                refreshCaptcha();
            } else {
                // æ˜¾ç¤ºå…·ä½“é”™è¯¯
                const errorMsg = d.error || 'æ³¨å†Œå¤±è´¥';
                if (errorMsg.includes('éªŒè¯ç ') || errorMsg.includes('captcha')) {
                    showError('reg-captcha-error', errorMsg);
                    refreshCaptcha();
                } else if (errorMsg.includes('ç”¨æˆ·') || errorMsg.includes('username')) {
                    showError('reg-user-error', errorMsg);
                } else if (errorMsg.includes('é‚®ç®±') || errorMsg.includes('email')) {
                    showError('reg-email-error', errorMsg);
                } else {
                    showError('reg-user-error', errorMsg);
                }
            }
        }).catch(() => {
            setButtonLoading('btn-register', false, 'æ­£åœ¨æ³¨å†Œ...', 'æ³¨å†Œè´¦æˆ·');
            showError('reg-user-error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // ========================================================================
    // æ‰“å¼€æ¨¡æ€æ¡†å·¥å…·å‡½æ•°
    // ========================================================================
    function openAuthModal(type, message) {
        const modal = new bootstrap.Modal(document.getElementById('authModal'));
        modal.show();
        
        // è‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”æ ‡ç­¾
        const tabId = type === 'register' ? '#register-tab' : '#login-tab';
        const tabBtn = document.querySelector(`button[data-bs-target="${tabId}"]`);
        if (tabBtn) {
            bootstrap.Tab.getInstance(tabBtn) || new bootstrap.Tab(tabBtn).show();
        }
        
        if(type === 'register') refreshCaptcha();
        
        // å¦‚æœæœ‰æç¤ºæ¶ˆæ¯ï¼Œæ˜¾ç¤ºåœ¨ç”¨æˆ·åè¾“å…¥æ¡†ä¸Šæ–¹
        if (message) {
            setTimeout(() => {
                showError('login-user-error', message);
            }, 300);
        }
    }

    // ========================================================================
    // éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„åŠŸèƒ½
    // ========================================================================
    function requireLogin() {
        openAuthModal('login', 'è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ•°æ®åˆ†æåŠŸèƒ½');
    }

    // ========================================================================
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    // ========================================================================
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–ç™»å½•æ–¹å¼ä¸ºå¯†ç ç™»å½•
        switchLoginMode('password');
        
        const captchaImg = document.getElementById('captcha-img');
        if (captchaImg) {
            refreshCaptcha();
        }
        
        // ä¸ºè¾“å…¥æ¡†æ·»åŠ å®æ—¶éªŒè¯ï¼ˆæ¸…é™¤é”™è¯¯æç¤ºï¼‰
        const inputs = document.querySelectorAll('.input-group-auth input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                const errorId = this.id + '-error';
                hideError(errorId);
            });
        });
        
        // æ”¯æŒå›è½¦é”®ç™»å½•
        document.getElementById('login-pass').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        document.getElementById('login-user').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
    });
</script>
{% block scripts %}{% endblock %}
</body>
</html>
