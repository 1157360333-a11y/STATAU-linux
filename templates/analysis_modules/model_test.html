<!-- æ¨¡å‹æ£€éªŒæ¨¡å— (Fæ£€éªŒ & Hausmanæ£€éªŒ) -->
<div id="module-test" class="analysis-module">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="m-0 text-primary fw-bold" id="test-method-title">ğŸ”¬ æ¨¡å‹æ£€éªŒé…ç½®</h6>
            <button class="btn btn-sm btn-light" onclick="toggleModulePanel('test')">æŠ˜å /å±•å¼€</button>
        </div>
        <div class="card-body" id="test-config-body">
            
            <!-- å˜é‡é€‰æ‹©åŒºåŸŸ -->
            <div class="row g-3 mb-3">
                <div class="col-md-12">
                    <label class="small fw-bold">å› å˜é‡ (Y) <span class="text-danger">*</span></label>
                    <select id="test-y-var-select" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">è‡ªå˜é‡ (X)</label>
                    <div id="test-x-var-container" class="var-list-container"></div>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">æ§åˆ¶å˜é‡</label>
                    <div id="test-c-var-container" class="var-list-container"></div>
                </div>
                <div class="col-md-12">
                    <input type="text" id="test-manual-controls" class="form-control form-control-sm" placeholder="æ‰‹åŠ¨è¾“å…¥æ§åˆ¶å˜é‡ (ç©ºæ ¼åˆ†éš”)...">
                </div>
            </div>

            <!-- é¢æ¿æ•°æ®è®¾ç½®ï¼ˆå¿…é¡»ï¼‰ -->
            <div class="mt-3 p-3 bg-light rounded border">
                <h6 class="fw-bold small text-primary"><i class="bi bi-layers"></i> é¢æ¿ç»“æ„è®¾ç½®</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="small fw-bold">ä¸ªä½“ID (Entity) <span class="text-danger">*</span></label>
                        <select id="test-entity-select" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold">æ—¶é—´ID (Time) <span class="text-danger">*</span></label>
                        <select id="test-time-select" class="form-select form-select-sm"></select>
                    </div>
                </div>
            </div>

            <!-- Hausmanæ£€éªŒç‰¹å®šè®¾ç½® -->
            <div id="test-hausman-settings" class="mt-3 p-3 bg-light rounded border" style="display:none;">
                <h6 class="fw-bold small text-primary"><i class="bi bi-gear"></i> Hausmanæ£€éªŒé€‰é¡¹</h6>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="test-sigmamore-checkbox">
                    <label class="form-check-label" for="test-sigmamore-checkbox">
                        <strong>ä½¿ç”¨sigmamoreé€‰é¡¹</strong> (åŸºäºéšæœºæ•ˆåº”ç»Ÿä¸€æ–¹å·®ä¼°è®¡)
                    </label>
                    <div class="form-text small">
                        å¯ç”¨æ­¤é€‰é¡¹å¯ä»¥è§£å†³åæ–¹å·®çŸ©é˜µä¸æ­£å®šçš„é—®é¢˜ï¼Œå¾—åˆ°ä¸Stataä¸€è‡´çš„æ£€éªŒç»“æœã€‚
                        <br>ä¸å¯ç”¨æ—¶ä½¿ç”¨åŸå§‹åæ–¹å·®çŸ©é˜µï¼Œå¯èƒ½é‡åˆ°"V_b-V_B is not positive definite"è­¦å‘Šã€‚
                    </div>
                </div>
            </div>

            <hr class="my-3">

            <!-- æ ¼å¼è®¾ç½® -->
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <label class="small fw-bold">æ•°å€¼å°æ•°ä½</label>
                    <input type="number" id="test-decimal-input" class="form-control form-control-sm" value="4" min="1" max="6">
                </div>
            </div>

            <!-- è¿è¡ŒæŒ‰é’® -->
            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary btn-sm flex-grow-1" id="btn-test-run" onclick="runModelTest()">
                    <span class="spinner-border spinner-border-sm d-none"></span>
                    <span class="btn-text">æ‰§è¡Œæ£€éªŒ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒº -->
    <div id="test-result-container" style="display:none; padding-bottom: 50px;">
        <div class="d-flex justify-content-center gap-3 mb-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleModulePanel('test', true)">é‡æ–°é…ç½®</button>
        </div>
        
        <!-- å¯¼å‡ºæŒ‰é’®ç»„ -->
        <div id="export-buttons-test" class="my-3">
            <div class="card shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <strong><i class="bi bi-download"></i> å¯¼å‡ºç»“æœ</strong>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" onclick="exportToWord()" title="å¯¼å‡ºä¸ºWordæ–‡æ¡£">
                                <i class="bi bi-file-word"></i> Word
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="exportToExcel()" title="å¯¼å‡ºä¸ºExcelè¡¨æ ¼">
                                <i class="bi bi-file-excel"></i> Excel
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="exportToTxt()" title="å¯¼å‡ºä¸ºçº¯æ–‡æœ¬">
                                <i class="bi bi-file-text"></i> TXT
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="exportToCSV()" title="å¯¼å‡ºä¸ºCSVæ–‡ä»¶">
                                <i class="bi bi-filetype-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="test-table-output"></div>
    </div>
</div>

<script>
// æ¨¡å‹æ£€éªŒæ¨¡å—å…¨å±€å˜é‡
let testCurrentMethod = 'f_test';

// æ¨¡å‹æ£€éªŒæ¨¡å—ä¸“ç”¨å‡½æ•°
function initTestModule(columns) {
    // å¡«å……ä¸‹æ‹‰é€‰æ‹©æ¡†
    const selects = ['test-y-var-select', 'test-entity-select', 'test-time-select'];
    selects.forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
        columns.forEach(col => el.add(new Option(col, col)));
    });
    
    // å¡«å……å¤é€‰æ¡†åˆ—è¡¨
    const fillContainer = (id, cls) => {
        const con = document.getElementById(id);
        con.innerHTML = '';
        columns.forEach(col => {
            con.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input ${cls}" type="checkbox" value="${col}" id="${id}-${col}">
                    <label class="form-check-label small text-truncate" for="${id}-${col}">${col}</label>
                </div>
            `;
        });
    };
    
    fillContainer('test-x-var-container', 'test-x-box');
    fillContainer('test-c-var-container', 'test-c-box');
}

function setTestMethod(method) {
    testCurrentMethod = method;
    
    const titleMap = {
        'f_test': 'ğŸ”¬ Fæ£€éªŒé…ç½® (å›ºå®šæ•ˆåº” vs æ··åˆOLS)',
        'hausman': 'ğŸ§ª Hausmanæ£€éªŒé…ç½® (å›ºå®šæ•ˆåº” vs éšæœºæ•ˆåº”)'
    };
    
    document.getElementById('test-method-title').innerText = titleMap[method] || 'æ¨¡å‹æ£€éªŒé…ç½®';
    
    // Hausmanæ£€éªŒæ˜¾ç¤ºç‰¹å®šè®¾ç½®
    document.getElementById('test-hausman-settings').style.display = (method === 'hausman') ? 'block' : 'none';
}

function runModelTest() {
    const btn = document.getElementById('btn-test-run');
    const spinner = btn.querySelector('.spinner-border');
    
    // æ”¶é›†å˜é‡
    const y_var = document.getElementById('test-y-var-select').value;
    const xVars = Array.from(document.querySelectorAll('.test-x-box:checked')).map(e => e.value);
    const cVars = Array.from(document.querySelectorAll('.test-c-box:checked')).map(e => e.value);
    const manual = document.getElementById('test-manual-controls').value;
    const panel_entity = document.getElementById('test-entity-select').value;
    const panel_time = document.getElementById('test-time-select').value;
    const decimals = document.getElementById('test-decimal-input').value;
    
    // å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„æ§åˆ¶å˜é‡
    let allXVars = xVars.concat(cVars);
    if (manual) {
        const manualVars = manual.split(/[\s,]+/).filter(v => v.trim() !== '');
        allXVars = allXVars.concat(manualVars);
    }
    
    // æ ¡éªŒ
    if (!y_var) {
        alert("è¯·é€‰æ‹©å› å˜é‡ Y");
        return;
    }
    if (allXVars.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè‡ªå˜é‡æˆ–æ§åˆ¶å˜é‡");
        return;
    }
    if (!panel_entity || !panel_time) {
        alert("æ¨¡å‹æ£€éªŒå¿…é¡»è®¾ç½® Entity å’Œ Time ID");
        return;
    }
    
    const payload = {
        filename: window.currentFilename,
        y_var: y_var,
        x_vars: allXVars,
        panel_entity: panel_entity,
        panel_time: panel_time,
        decimals: decimals
    };
    
    // Hausmanæ£€éªŒç‰¹æœ‰å‚æ•°
    if (testCurrentMethod === 'hausman') {
        payload.sigmamore = document.getElementById('test-sigmamore-checkbox').checked;
    }
    
    btn.disabled = true;
    spinner.classList.remove('d-none');
    
    const endpoint = testCurrentMethod === 'f_test' ? '/f_test' : '/hausman_test';
    
    fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert("æ£€éªŒé”™è¯¯: " + data.error);
        } else {
            displayTestResult(data.result, testCurrentMethod);
            document.getElementById('test-result-container').style.display = 'block';
            toggleModulePanel('test', false);
        }
    })
    .catch(e => alert("æœåŠ¡å™¨é”™è¯¯: " + e))
    .finally(() => {
        btn.disabled = false;
        spinner.classList.add('d-none');
    });
}

function displayTestResult(result, testType) {
    let html = '<div class="card shadow-sm"><div class="card-body">';
    
    if (result.error) {
        html += `<div class="alert alert-warning"><strong>æ³¨æ„ï¼š</strong>${result.error}</div>`;
        html += `<p class="text-muted">${result.suggestion || ''}</p>`;
        
        // å³ä½¿æœ‰é”™è¯¯ï¼Œä¹Ÿæ˜¾ç¤ºç³»æ•°å¯¹æ¯”
        if (result.fe_coeffs && result.re_coeffs) {
            html += '<h6 class="mt-3">ç³»æ•°å¯¹æ¯”ï¼š</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-bordered">';
            html += '<thead class="table-light"><tr><th>å˜é‡</th><th>å›ºå®šæ•ˆåº” (b)</th><th>éšæœºæ•ˆåº” (B)</th><th>å·®å¼‚ (b-B)</th>';
            if (result.fe_std_err) html += '<th>FEæ ‡å‡†è¯¯</th><th>REæ ‡å‡†è¯¯</th>';
            html += '</tr></thead><tbody>';
            for (let key in result.fe_coeffs) {
                html += `<tr><td>${key}</td><td>${result.fe_coeffs[key]}</td><td>${result.re_coeffs[key]}</td>`;
                html += `<td>${result.coeff_diff ? result.coeff_diff[key] : '-'}</td>`;
                if (result.fe_std_err) {
                    html += `<td>${result.fe_std_err[key]}</td><td>${result.re_std_err[key]}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
        }
    } else {
        html += `<h5 class="text-primary mb-3">${result.test_name}</h5>`;
        
        // å‡è®¾æ£€éªŒ
        html += '<div class="row mb-3">';
        html += '<div class="col-md-6">';
        html += `<p><strong>åŸå‡è®¾ (Hâ‚€)ï¼š</strong><br>${result.null_hypothesis}</p>`;
        html += '</div>';
        html += '<div class="col-md-6">';
        html += `<p><strong>å¤‡æ‹©å‡è®¾ (Hâ‚)ï¼š</strong><br>${result.alternative_hypothesis}</p>`;
        html += '</div>';
        html += '</div>';
        
        // æ£€éªŒç»Ÿè®¡é‡
        html += '<div class="table-responsive mb-3">';
        html += '<table class="table table-bordered table-sm">';
        html += '<thead class="table-light"><tr><th>ç»Ÿè®¡é‡</th><th>å€¼</th></tr></thead>';
        html += '<tbody>';
        
        if (testType === 'f_test') {
            html += `<tr><td>Fç»Ÿè®¡é‡</td><td>${result.f_statistic}${result.significance}</td></tr>`;
            html += `<tr><td>è‡ªç”±åº¦ (df1, df2)</td><td>(${result.df1}, ${result.df2})</td></tr>`;
            html += `<tr><td>På€¼</td><td>${result.p_value}</td></tr>`;
            html += `<tr><td>RSS (Pooled OLS)</td><td>${result.rss_pooled}</td></tr>`;
            html += `<tr><td>RSS (Fixed Effects)</td><td>${result.rss_fe}</td></tr>`;
            html += `<tr><td>ä¸ªä½“æ•°é‡</td><td>${result.n_entities}</td></tr>`;
            html += `<tr><td>è§‚æµ‹æ•°é‡</td><td>${result.n_obs}</td></tr>`;
        } else {
            html += `<tr><td>å¡æ–¹ç»Ÿè®¡é‡ (Ï‡Â²)</td><td>${result.chi2_statistic}${result.significance}</td></tr>`;
            html += `<tr><td>è‡ªç”±åº¦ (df)</td><td>${result.df}</td></tr>`;
            html += `<tr><td>På€¼</td><td>${result.p_value}</td></tr>`;
        }
        
        html += '</tbody></table></div>';
        
        // ç»“è®º
        html += `<div class="alert alert-${result.p_value < 0.05 ? 'success' : 'info'}">`;
        html += `<strong>ç»“è®ºï¼š</strong>${result.conclusion}`;
        html += '</div>';
        
        // æ˜¾è‘—æ€§è¯´æ˜
        html += '<p class="text-muted small">*** p<0.01, ** p<0.05, * p<0.1</p>';
        
        // Hausmanæ£€éªŒæ˜¾ç¤ºè¯¦ç»†ç³»æ•°å¯¹æ¯”
        if (testType === 'hausman' && result.fe_coeffs && result.re_coeffs) {
            html += '<h6 class="mt-3">ç³»æ•°å¯¹æ¯”ï¼ˆCoefficientsï¼‰ï¼š</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-bordered">';
            html += '<thead class="table-light"><tr><th>å˜é‡</th><th>å›ºå®šæ•ˆåº” (b)</th><th>éšæœºæ•ˆåº” (B)</th><th>å·®å¼‚ (b-B)</th>';
            if (result.fe_std_err) html += '<th>FEæ ‡å‡†è¯¯</th><th>REæ ‡å‡†è¯¯</th>';
            if (result.std_err_diff) html += '<th>å·®å¼‚æ ‡å‡†è¯¯ sqrt(V_b-V_B)</th>';
            html += '</tr></thead><tbody>';
            for (let key in result.fe_coeffs) {
                html += `<tr><td>${key}</td><td>${result.fe_coeffs[key]}</td><td>${result.re_coeffs[key]}</td>`;
                html += `<td>${result.coeff_diff ? result.coeff_diff[key] : '-'}</td>`;
                if (result.fe_std_err) {
                    html += `<td>${result.fe_std_err[key]}</td><td>${result.re_std_err[key]}</td>`;
                }
                if (result.std_err_diff) {
                    html += `<td>${result.std_err_diff[key]}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            html += '<p class="text-muted small mt-2">b = Consistent under H0 and Ha (å›ºå®šæ•ˆåº”ä¼°è®¡)<br>';
            html += 'B = Inconsistent under Ha, efficient under H0 (éšæœºæ•ˆåº”ä¼°è®¡)</p>';
        }
    }
    
    html += '</div></div>';
    document.getElementById('test-table-output').innerHTML = html;
}
</script>
